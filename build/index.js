(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.element,r=window.wp.components,n=async(e,t,a={})=>{try{const r=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!r)throw new Error("No provider configured. Please check your plugin settings.");const n=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_has_api_key;if(!n)throw new Error("No API key configured for the selected provider. Please add one in the KaiGen settings.");const i={prompt:e,provider:r};a.sourceImageUrls&&Array.isArray(a.sourceImageUrls)?i.source_image_urls=a.sourceImageUrls:a.sourceImageUrl&&(i.source_image_url=a.sourceImageUrl),a.additionalImageUrls&&Array.isArray(a.additionalImageUrls)&&(i.additional_image_urls=a.additionalImageUrls),a.maskUrl&&(i.mask_url=a.maskUrl),a.moderation&&["auto","low"].includes(a.moderation)&&(i.moderation=a.moderation),a.style&&["natural","vivid"].includes(a.style)&&(i.style=a.style),a.aspectRatio&&["1:1","16:9","9:16","4:3","3:4"].includes(a.aspectRatio)&&(i.aspect_ratio=a.aspectRatio);const o=await wp.apiFetch({path:"/kaigen/v1/generate-image",method:"POST",data:i});if(o.code&&o.message){if("content_moderation"===o.code)throw new Error(o.message);if("replicate_error"===o.code)throw new Error("Image generation failed: "+o.message);throw new Error(o.message)}if(!o||!o.url)throw new Error("Invalid response from server: "+JSON.stringify(o));o.id&&"number"==typeof o.id&&o.id>0?t({url:o.url,alt:e,id:o.id,caption:""}):t({url:o.url,alt:e,caption:""})}catch(e){t({error:e.message||"An unknown error occurred while generating the image"})}},i=window.kaiGen?.logoUrl,o=({isOpen:e,onClose:o,onSelect:l,initialReferenceImage:c})=>{const[s,m]=(0,a.useState)(""),[d,g]=(0,a.useState)(!1),[u,p]=(0,a.useState)(null),[k,b]=(0,a.useState)([]),[E,h]=(0,a.useState)([]),[w,f]=(0,a.useState)("1:1"),_="replicate"===(wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider||"replicate")?10:16;(0,a.useEffect)(()=>{e&&((async()=>{try{const e=await wp.apiFetch({path:"/kaigen/v1/reference-images",method:"GET"});return Array.isArray(e)?e:[]}catch(e){return console.error("Failed to fetch reference images:",e),[]}})().then(b),c&&c.url?h([c]):h([]))},[e,c]);const v=()=>{if(!s.trim())return void p("Please enter a prompt for image generation.");g(!0),p(null);const e={};E.length>0&&(e.sourceImageUrls=E.map(e=>e.url)),w&&(e.aspectRatio=w),n(s.trim(),e=>{e.error?(p(e.error),g(!1)):(l(e),g(!1),y())},e)},y=()=>{m(""),p(null),h([]),o()};return e?(0,t.createElement)(r.Modal,{className:"kaigen-modal",title:(0,t.createElement)("div",{className:"kaigen-modal__logo-container"},(0,t.createElement)("img",{src:i,alt:"KaiGen logo",className:"kaigen-modal__logo"})),"aria-label":"KaiGen",onRequestClose:y},u&&(0,t.createElement)("p",{className:"kaigen-error-text"},u),(0,t.createElement)("div",{className:"kaigen-modal__input-container"},(0,t.createElement)(r.Dropdown,{popoverProps:{placement:"bottom-start",focusOnMount:!0},renderToggle:({isOpen:e,onToggle:a})=>(0,t.createElement)(r.Button,{className:"kaigen-modal__ref-button "+(E.length>0?"kaigen-ref-button-selected":""),onClick:a,"aria-expanded":e,"aria-label":"Reference Images"},(0,t.createElement)(r.Dashicon,{icon:"format-image",className:E.length>0?"kaigen-ref-button-icon-selected":""})),renderContent:()=>{const e=c?[c,...k.filter(e=>e.id!==c.id)]:k;return(0,t.createElement)("div",{className:"kaigen-modal-dropdown-content-container"},(0,t.createElement)("h4",{className:"kaigen-modal-dropdown-content-title"},"Reference Images (up to ",_,")"),e.length>0?(0,t.createElement)("div",{className:"kaigen-modal-reference-images-container"},e.map((e,a)=>(0,t.createElement)("img",{key:e.id||`initial-${a}`,src:e.url,alt:e.alt||"",onClick:()=>{h(t=>t.some(t=>t.url===e.url)?t.filter(t=>t.url!==e.url):t.length<_?[...t,e]:t)},className:"kaigen-modal-reference-image "+(E.some(t=>t.url===e.url)?"kaigen-modal-reference-image-selected":"")}))):(0,t.createElement)("p",{className:"kaigen-modal-no-references"},"No reference images. Mark images in the Media Library to use them here."))}}),(0,t.createElement)("div",{className:"kaigen-modal__textarea-container"},(0,t.createElement)(r.TextareaControl,{className:"kaigen-modal__textarea",placeholder:"Image prompt...",value:s,onChange:m,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),v())},rows:2,autoFocus:!0})),s.trim()&&(0,t.createElement)(r.Button,{className:"kaigen-modal__submit-button",variant:"primary",onClick:v,disabled:d||!s.trim(),"aria-label":"Generate Image"},d?(0,t.createElement)(r.Spinner,null):(0,t.createElement)(r.Dashicon,{icon:"admin-appearance"})),(0,t.createElement)(r.Dropdown,{popoverProps:{placement:"bottom-end",focusOnMount:!0},renderToggle:({isOpen:e,onToggle:a})=>(0,t.createElement)(r.Button,{className:"kaigen-modal__settings-button",onClick:a,"aria-expanded":e,"aria-label":"Settings"},(0,t.createElement)(r.Dashicon,{icon:"admin-generic"})),renderContent:()=>(0,t.createElement)("div",{className:"kaigen-modal-dropdown-content-container"},(0,t.createElement)("h4",{className:"kaigen-modal-dropdown-content-title"},"Aspect Ratio"),(0,t.createElement)("div",{className:"kaigen-modal-aspect-ratio-container"},[{value:"1:1",label:"1:1",title:"Square"},{value:"16:9",label:"16:9",title:"Landscape"},{value:"9:16",label:"9:16",title:"Portrait"}].map(e=>(0,t.createElement)("div",{key:e.value,onClick:()=>f(t=>t===e.value?null:e.value),"aria-pressed":w===e.value,"aria-label":`${e.title} (${e.label})`,className:"kaigen-modal__aspect-ratio-button "+(w===e.value?"kaigen-modal__aspect-ratio-button-selected":"")},(0,t.createElement)("div",{className:"kaigen-modal-aspect-ratio-icon-container"},(0,t.createElement)("div",{className:`kaigen-modal-aspect-ratio-icon ${w===e.value?"kaigen-modal-aspect-ratio-icon-selected":""} kaigen-aspect-ratio-${e.value.replace(":","-")}`})),(0,t.createElement)("span",{className:"kaigen-modal-aspect-ratio-label"},e.label)))))}))):null},l=window.kaiGen?.logoUrl,c=({onSelect:e,shouldDisplay:n})=>{const[i,c]=(0,a.useState)(!1);return n?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.Button,{onClick:()=>c(!0),className:"kaigen-placeholder-button","aria-label":"KaiGen"},(0,t.createElement)("img",{src:l,alt:"KaiGen",style:{width:"48px",height:"48px"}})),(0,t.createElement)("button",{type:"button",role:"menuitem",onClick:()=>c(!0),className:"components-button components-menu-item__button is-next-40px-default-size kaigen-menu-item-button"},(0,t.createElement)("span",{className:"components-menu-item__item"},"KaiGen"),(0,t.createElement)("img",{src:l,alt:"","aria-hidden":"true",className:"components-menu-items__item-icon has-icon-right",style:{width:"24px",height:"24px"}})),(0,t.createElement)(o,{isOpen:i,onClose:()=>c(!1),onSelect:e})):null},s=window.kaiGen?.logoUrl,m=({isGenerating:e,onGenerateImage:n,isRegenerating:i,onImageGenerated:l,isImageBlock:c,isTextSelected:m,currentImage:d})=>{const[g,u]=(0,a.useState)(!1);return c?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.ToolbarGroup,null,(0,t.createElement)(r.ToolbarButton,{icon:i?(0,t.createElement)(r.Spinner,null):(0,t.createElement)("img",{src:s,alt:"KaiGen logo",className:"kaigen-toolbar-icon"}),label:i?"KaiGen is generating...":"KaiGen",onClick:()=>u(!0),disabled:i})),(0,t.createElement)(o,{isOpen:g,onClose:()=>u(!1),onSelect:l,initialReferenceImage:d})):m?(0,t.createElement)(r.ToolbarGroup,null,(0,t.createElement)(r.ToolbarButton,{icon:e?(0,t.createElement)(r.Spinner,null):"format-image",label:e?"KaiGen is generating...":"KaiGen",onClick:n,disabled:e})):null},d=window.wp.blockEditor,g=window.wp.data;(0,window.wp.richText.registerFormatType)("kaigen/custom-format",{title:"AI Image Gen",tagName:"span",className:"kaigen-format",edit:({isActive:e,value:r,onChange:i})=>{const[o,l]=(0,a.useState)(!1),c=(0,g.useSelect)(e=>e("core/block-editor").getSelectedBlock(),[]),{replaceBlocks:s}=(0,g.useDispatch)("core/block-editor"),u=(0,a.useCallback)(()=>{if(c&&"core/paragraph"===c.name){const e=r.text.slice(r.start,r.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!t)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please set one in the plugin settings.",{type:"snackbar"});const a=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,className:"kaigen-text-center"});s(c.clientId,[a,c]),l(!0),n(e,e=>{if(l(!1),e.error)wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),s(a.clientId,[]);else{const t={url:e.url,alt:e.alt,caption:""};e.id&&"number"==typeof e.id&&e.id>0&&(t.id=e.id);const r=wp.blocks.createBlock("core/image",t);s(a.clientId,[r])}})}},[c,r.text,r.start,r.end,s]),p=""!==r.text.slice(r.start,r.end).trim();return(0,t.createElement)(d.BlockControls,null,(0,t.createElement)(m,{isGenerating:o,onGenerateImage:u,isTextSelected:p}))}});const u=window.wp.hooks;(0,u.addFilter)("editor.MediaUpload","kaigen/add-ai-tab",e=>a=>{const r=a.allowedTypes&&a.allowedTypes.includes("image")&&!a.multiple,n=wp.data.select("core/block-editor").getSelectedBlock(),i=n&&"core/image"===n.name,o=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_has_api_key,l=r&&i&&!(n&&n.attributes&&n.attributes.url)&&o;return(0,t.createElement)(e,{...a,render:e=>(0,t.createElement)(t.Fragment,null,a.render(e),(0,t.createElement)(c,{onSelect:a.onSelect,shouldDisplay:l}))})});const p=window.wp.apiFetch;var k=e.n(p);(0,u.addFilter)("editor.BlockEdit","kaigen/add-regenerate-button",e=>n=>{if("core/image"!==n.name)return(0,t.createElement)(e,{...n});const i=n.attributes.id&&"number"==typeof n.attributes.id&&n.attributes.id>0,[o,l]=(0,a.useState)(!1),[c,s]=(0,a.useState)(!1);(0,a.useEffect)(()=>{i&&!c&&(void 0===n.attributes.kaigen_reference_image||null===n.attributes.kaigen_reference_image?k()({path:`/wp/v2/media/${n.attributes.id}`}).then(e=>{if(e&&e.meta&&void 0!==e.meta.kaigen_reference_image){const t=!0===e.meta.kaigen_reference_image||1===e.meta.kaigen_reference_image;n.setAttributes({kaigen_reference_image:t})}s(!0)}).catch(()=>{s(!0)}):s(!0))},[i,n.attributes.id,n.attributes.kaigen_reference_image,c]);const g=n.attributes.url?{url:n.attributes.url,id:n.attributes.id,alt:n.attributes.alt||""}:null;return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(e,{...n}),n.attributes.url&&(0,t.createElement)(d.BlockControls,null,(0,t.createElement)(m,{isRegenerating:o,onImageGenerated:e=>{e.id&&"number"==typeof e.id&&e.id>0?n.setAttributes({url:e.url,id:e.id}):n.setAttributes({url:e.url,id:void 0}),wp.data.dispatch("core/notices").createSuccessNotice("Image generated successfully!",{type:"snackbar"})},isImageBlock:!0,currentImage:g})),i&&(0,t.createElement)(d.InspectorControls,null,(0,t.createElement)(r.PanelBody,{title:"KaiGen Settings",initialOpen:!1},(0,t.createElement)(r.CheckboxControl,{label:"Reference image",checked:!0===n.attributes.kaigen_reference_image,onChange:async e=>{const t=!0===e;n.setAttributes({kaigen_reference_image:t}),s(!0);try{await k()({path:`/wp/v2/media/${n.attributes.id}`,method:"POST",data:{meta:{kaigen_reference_image:t?1:0}}})}catch(e){wp.data.dispatch("core/notices").createErrorNotice("Failed to update reference image meta",{type:"snackbar"})}},help:"Add to the list of reference images."}))))}),(0,u.addFilter)("blocks.registerBlockType","kaigen/add-reference-image-attribute",(e,t)=>"core/image"!==t?e:{...e,attributes:{...e.attributes,kaigen_reference_image:{type:"boolean",default:!1}}})})();