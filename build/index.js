(()=>{"use strict";const e=window.React,t=window.wp.element,r=window.wp.components,a=async(e,t,r={})=>{try{const a=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!a)throw new Error("No provider configured. Please check your plugin settings.");const n={prompt:e,provider:a};r.sourceImageUrl&&(n.source_image_url=r.sourceImageUrl),r.additionalImageUrls&&Array.isArray(r.additionalImageUrls)&&(n.additional_image_urls=r.additionalImageUrls),r.maskUrl&&(n.mask_url=r.maskUrl),r.moderation&&["auto","low"].includes(r.moderation)&&(n.moderation=r.moderation),r.style&&["natural","vivid"].includes(r.style)&&(n.style=r.style);const o=await wp.apiFetch({path:"/kaigen/v1/generate-image",method:"POST",data:n});if(o.code&&o.message){if("content_moderation"===o.code)throw new Error(o.message);if("replicate_error"===o.code)throw new Error("Image generation failed: "+o.message);throw new Error(o.message)}if(!o||!o.url)throw new Error("Invalid response from server: "+JSON.stringify(o));o.id&&"number"==typeof o.id&&o.id>0?t({url:o.url,alt:e,id:o.id,caption:""}):t({url:o.url,alt:e,caption:""})}catch(e){console.error("Image generation failed:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),t({error:e.message||"An unknown error occurred while generating the image"})}},n=({onSelect:n,shouldDisplay:o})=>{const[i,l]=(0,t.useState)(!1),[c,s]=(0,t.useState)(""),[d,m]=(0,t.useState)(!1),[u,g]=(0,t.useState)(null);return o?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"block-editor-media-placeholder__url-input-container"},(0,e.createElement)(r.Button,{variant:"secondary",onClick:()=>l(!0),className:"components-button is-next-40px-default-size is-secondary"},"KaiGen")),i&&(0,e.createElement)(r.Modal,{title:"KaiGen",onRequestClose:()=>l(!1)},u&&(0,e.createElement)("p",{style:{color:"red"}},u),(0,e.createElement)(r.TextareaControl,{label:"Prompt",value:c,onChange:s,rows:4}),(0,e.createElement)(r.Button,{variant:"primary",onClick:()=>{c.trim()?(m(!0),g(null),a(c.trim(),(e=>{e.error?(g(e.error),m(!1)):(n(e),m(!1),l(!1))}))):g("Please enter a prompt for image generation.")},disabled:d||!c.trim()},d?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(r.Spinner,null)," ","KaiGen is generating..."):"KaiGen"))):null},o=({isGenerating:a,onGenerateImage:n,isRegenerating:o,onRegenerateImage:i,isImageBlock:l,isTextSelected:c,supportsImageToImage:s})=>{const[d,m]=(0,t.useState)(!1),[u,g]=(0,t.useState)(""),[p,w]=(0,t.useState)(null);return l&&s?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(r.ToolbarGroup,null,(0,e.createElement)(r.ToolbarButton,{icon:o?(0,e.createElement)(r.Spinner,null):"update",label:o?"KaiGen is generating...":"KaiGen",onClick:()=>m(!0),disabled:o})),d&&(0,e.createElement)(r.Modal,{title:"KaiGen : Edit Image",onRequestClose:()=>{m(!1),g(""),w(null)}},p&&(0,e.createElement)("p",{style:{color:"red"}},p),(0,e.createElement)(r.TextareaControl,{label:"Editing Instructions (optional)",value:u,onChange:g,rows:4}),(0,e.createElement)(r.Button,{variant:"primary",onClick:()=>{i(u.trim()),m(!1),g(""),w(null)},disabled:o},o?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(r.Spinner,null),"Regenerating..."):"Regenerate Image"))):c?(0,e.createElement)(r.ToolbarGroup,null,(0,e.createElement)(r.ToolbarButton,{icon:a?(0,e.createElement)(r.Spinner,null):"format-image",label:a?"KaiGen is generating...":"KaiGen",onClick:n,disabled:a})):null},i=window.wp.blockEditor,l=window.wp.data;(0,window.wp.richText.registerFormatType)("kaigen/custom-format",{title:"AI Image Gen",tagName:"span",className:"kaigen-format",edit:({isActive:r,value:n,onChange:c})=>{const[s,d]=(0,t.useState)(!1),m=(0,l.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:u}=(0,l.useDispatch)("core/block-editor"),g=(0,t.useCallback)((()=>{if(m&&"core/paragraph"===m.name){const e=n.text.slice(n.start,n.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!t)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please set one in the plugin settings.",{type:"snackbar"});const r=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,style:{textAlign:"center"}});u(m.clientId,[r,m]),d(!0),a(e,(e=>{if(d(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),u(r.clientId,[]);else{let t={url:e.url,alt:e.alt,caption:""};e.id&&"number"==typeof e.id&&e.id>0&&(t.id=e.id);const a=wp.blocks.createBlock("core/image",t);u(r.clientId,[a])}}))}}),[m,n.text,n.start,n.end,u]),p=""!==n.text.slice(n.start,n.end).trim();return(0,e.createElement)(i.BlockControls,null,(0,e.createElement)(o,{isGenerating:s,onGenerateImage:g,isTextSelected:p}))}});const c=window.wp.hooks;(0,c.addFilter)("editor.MediaUpload","kaigen/add-ai-tab",(t=>r=>{const a=r.allowedTypes&&r.allowedTypes.includes("image")&&!r.multiple,o=wp.data.select("core/block-editor").getSelectedBlock(),i=o&&"core/image"===o.name,l=a&&i&&!(o&&o.attributes&&o.attributes.url);return(0,e.createElement)(t,{...r,render:t=>(0,e.createElement)(e.Fragment,null,r.render(t),(0,e.createElement)(n,{onSelect:r.onSelect,shouldDisplay:l}))})})),(0,c.addFilter)("editor.BlockEdit","kaigen/add-regenerate-button",(r=>n=>{if("core/image"!==n.name)return(0,e.createElement)(r,{...n});const[l,c]=(0,t.useState)(!1),[s,d]=(0,t.useState)(null),[m,u]=(0,t.useState)(!1);return(0,t.useEffect)((()=>{(async()=>{try{const e=window.kaiGen?.provider,t=window.kaiGen?.supportsImageToImage||!1;if(!e)return void console.error("No provider configured in localized data");u(t)}catch(e){console.error("Failed to initialize provider:",e)}})()}),[]),(0,e.createElement)(e.Fragment,null,(0,e.createElement)(r,{...n}),(0,e.createElement)(i.BlockControls,null,(0,e.createElement)(o,{isRegenerating:l,onRegenerateImage:async e=>{d(null);const t=e||n.attributes.alt||"no alt text or prompt, please just enhance",r=window.kaiGen?.provider;if(!r)return console.error("No provider configured"),void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please check your plugin settings.",{type:"snackbar"});c(!0);try{const e=n.attributes.url,r={};m&&e?r.sourceImageUrl=e:m&&!e&&(console.warn("Image-to-image requested but no source image URL available"),wp.data.dispatch("core/notices").createWarningNotice("Image-to-image generation requires a source image. Please ensure the image is properly loaded.",{type:"snackbar"}));const o=await new Promise(((e,n)=>{a(t,(t=>{t.error?n(new Error(t.error)):e(t)}),r)}));o.id&&"number"==typeof o.id&&o.id>0?n.setAttributes({url:o.url,id:o.id}):n.setAttributes({url:o.url,id:void 0}),wp.data.dispatch("core/notices").createSuccessNotice("Image regenerated successfully!",{type:"snackbar"})}catch(e){console.error("Image regeneration failed:",e);let t=e.message||"Unknown error",r="";t.includes("organization verification")?r=" Please verify your organization in the OpenAI dashboard.":t.includes("parameter")?t="API configuration error. Please contact the plugin developer.":t.includes("content policy")&&(r=" Try a different prompt."),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+t+r,{type:"snackbar"})}finally{c(!1)}},isImageBlock:!0,supportsImageToImage:m})))}))})();