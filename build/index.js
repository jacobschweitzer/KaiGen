(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,a=window.wp.element,r=window.wp.components,n=async(e,t,a={})=>{try{const r=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!r)throw new Error("No provider configured. Please check your plugin settings.");const n=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_has_api_key;if(!n)throw new Error("No API key configured for the selected provider. Please add one in the KaiGen settings.");const l={prompt:e,provider:r};a.sourceImageUrls&&Array.isArray(a.sourceImageUrls)?l.source_image_urls=a.sourceImageUrls:a.sourceImageUrl&&(l.source_image_url=a.sourceImageUrl),a.sourceImageIds&&Array.isArray(a.sourceImageIds)&&(l.source_image_ids=a.sourceImageIds),a.additionalImageUrls&&Array.isArray(a.additionalImageUrls)&&(l.additional_image_urls=a.additionalImageUrls),a.maskUrl&&(l.mask_url=a.maskUrl),a.moderation&&["auto","low"].includes(a.moderation)&&(l.moderation=a.moderation),a.style&&["natural","vivid"].includes(a.style)&&(l.style=a.style),a.aspectRatio&&["1:1","16:9","9:16","4:3","3:4"].includes(a.aspectRatio)&&(l.aspect_ratio=a.aspectRatio),a.quality&&["low","medium","high"].includes(a.quality)&&(l.quality=a.quality);const i=wp.apiFetch({path:"/kaigen/v1/estimated-generation-time",method:"POST",data:l});"function"==typeof a.onEstimatedTime&&i.then(e=>{e&&"number"==typeof e.estimated_time_seconds&&a.onEstimatedTime(e.estimated_time_seconds)}).catch(()=>{});const o=await wp.apiFetch({path:"/kaigen/v1/generate-image",method:"POST",data:l});if(o.code&&o.message){if("content_moderation"===o.code)throw new Error(o.message);if("replicate_error"===o.code)throw new Error("Image generation failed: "+o.message);throw new Error(o.message)}if(!o||!o.url)throw new Error("Invalid response from server: "+JSON.stringify(o));o.id&&"number"==typeof o.id&&o.id>0?t({url:o.url,alt:e,id:o.id,caption:""}):t({url:o.url,alt:e,caption:""})}catch(e){t({error:e.message||"An unknown error occurred while generating the image"})}},l=(e,t)=>{const[r,n]=(0,a.useState)(0),l=(0,a.useRef)(3e4),i=(0,a.useRef)(null),o=(0,a.useRef)(0);return(0,a.useEffect)(()=>{l.current="number"==typeof t&&t>0?t:3e4},[t]),(0,a.useEffect)(()=>{if(!e)return n(0),i.current=null,void(o.current=0);i.current||(i.current=Date.now(),n(0),o.current=0);const t=setInterval(()=>{const e=Date.now()-i.current,t=Math.min(Math.floor(e/l.current*100),99),a=Math.max(t,o.current);o.current=a,n(a)},200);return()=>clearInterval(t)},[e]),r},i=window.kaiGen?.logoUrl,o=window.kaiGen?.featureFlags||{},s=({isOpen:e,onClose:s,onSelect:c,initialReferenceImage:m})=>{const[d,u]=(0,a.useState)(""),[g,p]=(0,a.useState)(!1),[h,k]=(0,a.useState)(null),[b,f]=(0,a.useState)([]),[E,w]=(0,a.useState)([]),[_,y]=(0,a.useState)("1:1"),[v,N]=(0,a.useState)("medium"),[I,S]=(0,a.useState)(null),[x,G]=(0,a.useState)([]),[A,C]=(0,a.useState)([]),T=wp.data.select("core/editor")?.getEditorSettings()||{},P=T.kaigen_provider||"replicate",B=T.kaigen_quality||"medium",O="replicate"===P?10:16,$=l(g,I),R=!0===o.bestOfImages,F=R&&"replicate"===P&&"low"===v,D=(0,a.useMemo)(()=>["Original","Detailed","Creative"],[]);(0,a.useEffect)(()=>{e&&((async()=>{try{const e=await wp.apiFetch({path:"/kaigen/v1/reference-images",method:"GET"});return Array.isArray(e)?e:[]}catch(e){return[]}})().then(f),N(B),G([]),C([]),m&&m.url?w([m]):w([]))},[e,m,B]),(0,a.useEffect)(()=>{G([]),C([])},[d,_,v,P,E]);const M=e=>`${e} with rich textures, cinematic lighting, sharp focus, and a cohesive color palette`,U=e=>{const t=e.toLowerCase();let a=" with a playful, unexpected twist that complements the scene";return["sport","sports","soccer","basketball","football","baseball","tennis","golf","hockey","running","cycling"].some(e=>t.includes(e))&&(a=" with dynamic sports energy, a cheering crowd, and dramatic motion blur"),["humor","humour","funny","comedy","joke","humorous","silly","whimsical"].some(e=>t.includes(e))&&(a=" with a surprising comedic element, like a quirky character photobombing the scene"),`${e}, reimagined${a}`},q=()=>{if(!d.trim())return void k("Please enter a prompt for image generation.");p(!0),S(null),k(null),G([]),C([]);const e=(()=>{const e={};return E.length>0&&(e.sourceImageUrls=E.map(e=>e.url),e.sourceImageIds=E.map(e=>e.id).filter(e=>Number.isInteger(e)&&e>0)),_&&(e.aspectRatio=_),v&&(e.quality=v),e.onEstimatedTime=e=>{"number"==typeof e&&S(1e3*e)},e})(),t=d.trim();if(F){const a=(e=>[e,M(e),U(e)])(t);return C(a),void Promise.all(a.map(t=>((e,t)=>new Promise(a=>{n(e,a,t)}))(t,e))).then(e=>{const t=e.filter(e=>e.error);if(t.length)return k(t[0].error),void p(!1);G(e),p(!1)}).catch(()=>{k("An unknown error occurred while generating the images"),p(!1)})}n(t,e=>{e.error?(k(e.error),p(!1)):(c(e),p(!1),K())},e)},K=()=>{u(""),k(null),w([]),N(B),S(null),G([]),C([]),s()};return e?(0,t.createElement)(r.Modal,{className:"kaigen-modal",title:(0,t.createElement)("div",{className:"kaigen-modal__logo-container"},(0,t.createElement)("img",{src:i,alt:"KaiGen logo",className:"kaigen-modal__logo"})),"aria-label":"KaiGen",onRequestClose:K},h&&(0,t.createElement)("p",{className:"kaigen-error-text"},h),(0,t.createElement)("div",{className:"kaigen-modal__input-container"},(0,t.createElement)(r.Dropdown,{popoverProps:{placement:"bottom-start",focusOnMount:!0},renderToggle:({isOpen:e,onToggle:a})=>(0,t.createElement)(r.Button,{className:"kaigen-modal__ref-button "+(E.length>0?"kaigen-ref-button-selected":""),onClick:a,"aria-expanded":e,"aria-label":"Reference Images"},(0,t.createElement)(r.Dashicon,{icon:"format-image",className:E.length>0?"kaigen-ref-button-icon-selected":""})),renderContent:()=>{const e=m?[m,...b.filter(e=>e.id!==m.id)]:b;return(0,t.createElement)("div",{className:"kaigen-modal-dropdown-content-container"},(0,t.createElement)("h4",{className:"kaigen-modal-dropdown-content-title"},"Reference Images (up to ",O,")"),e.length>0?(0,t.createElement)("div",{className:"kaigen-modal-reference-images-container"},e.map((e,a)=>(0,t.createElement)("button",{type:"button",key:e.id||`initial-${a}`,onClick:()=>{w(t=>t.some(t=>t.url===e.url)?t.filter(t=>t.url!==e.url):t.length<O?[...t,e]:t)},className:"kaigen-modal-reference-image "+(E.some(t=>t.url===e.url)?"kaigen-modal-reference-image-selected":""),"aria-label":e.alt||"Select reference image"},(0,t.createElement)("img",{src:e.thumbnail_url||e.url,alt:e.alt||""})))):(0,t.createElement)("p",{className:"kaigen-modal-no-references"},"No reference images. Mark images in the Media Library to use them here."))}}),(0,t.createElement)("div",{className:"kaigen-modal__textarea-container"},(0,t.createElement)(r.TextareaControl,{className:"kaigen-modal__textarea",placeholder:"Image prompt...",value:d,onChange:u,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),q())},rows:2})),d.trim()&&(0,t.createElement)(r.Button,{className:"kaigen-modal__submit-button",variant:"primary",onClick:q,disabled:g||!d.trim(),"aria-label":F?"Generate Images":"Generate Image"},(0,t.createElement)(r.Dashicon,{icon:"admin-appearance"})),(0,t.createElement)(r.Dropdown,{popoverProps:{placement:"bottom-end",focusOnMount:!0},renderToggle:({isOpen:e,onToggle:a})=>(0,t.createElement)(r.Button,{className:"kaigen-modal__settings-button",onClick:a,"aria-expanded":e,"aria-label":"Settings"},(0,t.createElement)(r.Dashicon,{icon:"admin-generic"})),renderContent:()=>(0,t.createElement)("div",{className:"kaigen-modal-dropdown-content-container"},(0,t.createElement)("h4",{className:"kaigen-modal-dropdown-content-title"},"Aspect Ratio"),(0,t.createElement)("div",{className:"kaigen-modal-aspect-ratio-container"},[{value:"1:1",label:"1:1",title:"Square"},{value:"16:9",label:"16:9",title:"Landscape"},{value:"9:16",label:"9:16",title:"Portrait"}].map(e=>(0,t.createElement)("button",{type:"button",key:e.value,onClick:()=>y(t=>t===e.value?null:e.value),"aria-pressed":_===e.value,"aria-label":`${e.title} (${e.label})`,className:"kaigen-modal__aspect-ratio-button "+(_===e.value?"kaigen-modal__aspect-ratio-button-selected":"")},(0,t.createElement)("div",{className:"kaigen-modal-aspect-ratio-icon-container"},(0,t.createElement)("div",{className:`kaigen-modal-aspect-ratio-icon ${_===e.value?"kaigen-modal-aspect-ratio-icon-selected":""} kaigen-aspect-ratio-${e.value.replace(":","-")}`})),(0,t.createElement)("span",{className:"kaigen-modal-aspect-ratio-label"},e.label)))),(0,t.createElement)("h4",{className:"kaigen-modal-dropdown-content-title"},"Quality"),(0,t.createElement)("div",{className:"kaigen-modal-quality-container"},[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"}].map(e=>(0,t.createElement)("button",{type:"button",key:e.value,onClick:()=>N(e.value),"aria-pressed":v===e.value,className:"kaigen-modal__quality-button "+(v===e.value?"kaigen-modal__quality-button-selected":"")},e.label))),R&&"replicate"===P&&(0,t.createElement)("p",{className:"kaigen-modal__best-of-note"},"Best-of works with Replicate at Low quality."))})),F&&x.length>0&&(0,t.createElement)("div",{className:"kaigen-modal__best-of-results"},(0,t.createElement)("p",{className:"kaigen-modal__best-of-title"},"Pick your favorite"),(0,t.createElement)("div",{className:"kaigen-modal__best-of-grid"},x.map((e,a)=>(0,t.createElement)("button",{type:"button",key:`${e.url}-${a}`,className:"kaigen-modal__best-of-card",onClick:()=>{c(e),K()}},(0,t.createElement)("img",{src:e.url,alt:A[a]||d}),(0,t.createElement)("span",{className:"kaigen-modal__best-of-label"},D[a]))))),g&&(0,t.createElement)("div",{className:"kaigen-modal__progress"},(0,t.createElement)("div",{className:"kaigen-modal__progress-label"},"Generating... ",$,"%"),(0,t.createElement)("div",{className:"kaigen-modal__progress-track",role:"progressbar","aria-valuenow":$,"aria-valuemin":0,"aria-valuemax":100,"aria-label":"Image generation progress"},(0,t.createElement)("div",{className:"kaigen-modal__progress-fill",style:{width:`${$}%`}})))):null},c=window.kaiGen?.logoUrl,m=({onSelect:e,shouldDisplay:n})=>{const[l,i]=(0,a.useState)(!1);return n?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.Button,{onClick:()=>i(!0),className:"kaigen-placeholder-button","aria-label":"KaiGen"},(0,t.createElement)("img",{src:c,alt:"KaiGen",style:{width:"48px",height:"48px"}})),(0,t.createElement)("button",{type:"button",role:"menuitem",onClick:()=>i(!0),className:"components-button components-menu-item__button is-next-40px-default-size kaigen-menu-item-button"},(0,t.createElement)("span",{className:"components-menu-item__item"},"KaiGen"),(0,t.createElement)("img",{src:c,alt:"","aria-hidden":"true",className:"components-menu-items__item-icon has-icon-right",style:{width:"24px",height:"24px"}})),(0,t.createElement)(s,{isOpen:l,onClose:()=>i(!1),onSelect:e})):null},d=window.kaiGen?.logoUrl,u=({isGenerating:e,onGenerateImage:n,isRegenerating:i,onImageGenerated:o,isImageBlock:c,isTextSelected:m,currentImage:u,estimatedDurationMs:g})=>{const[p,h]=(0,a.useState)(!1),k=l(e||i,g),b=(0,t.createElement)("span",{className:"kaigen-progress-icon","aria-hidden":"true"},(0,t.createElement)("span",{className:"kaigen-progress-icon__track"},(0,t.createElement)("span",{className:"kaigen-progress-icon__fill",style:{width:`${k}%`}})));return c?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.ToolbarGroup,null,(0,t.createElement)(r.ToolbarButton,{icon:i?b:(0,t.createElement)("img",{src:d,alt:"KaiGen logo",className:"kaigen-toolbar-icon"}),label:i?`KaiGen is generating... ${k}%`:"KaiGen",onClick:()=>h(!0),disabled:i})),(0,t.createElement)(s,{isOpen:p,onClose:()=>h(!1),onSelect:o,initialReferenceImage:u})):m?(0,t.createElement)(r.ToolbarGroup,null,(0,t.createElement)(r.ToolbarButton,{icon:e?b:"format-image",label:e?`KaiGen is generating... ${k}%`:"KaiGen",onClick:n,disabled:e})):null},g=window.wp.blockEditor,p=window.wp.data,h=window.wp.richText,k=({value:e})=>{const[r,l]=(0,a.useState)(!1),[i,o]=(0,a.useState)(null),s=(0,p.useSelect)(e=>e("core/block-editor").getSelectedBlock(),[]),{replaceBlocks:c}=(0,p.useDispatch)("core/block-editor"),m=(0,a.useCallback)(()=>{if(s&&"core/paragraph"===s.name){const t=e.text.slice(e.start,e.end).trim();if(!t)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const a=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!a)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please set one in the plugin settings.",{type:"snackbar"});const r=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,className:"kaigen-text-center"});c(s.clientId,[r,s]),l(!0),o(null),n(t,e=>{if(l(!1),o(null),e.error)wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),c(r.clientId,[]);else{const t={url:e.url,alt:e.alt,caption:""};e.id&&"number"==typeof e.id&&e.id>0&&(t.id=e.id);const a=wp.blocks.createBlock("core/image",t);c(r.clientId,[a])}},{onEstimatedTime:e=>{"number"==typeof e&&o(1e3*e)}})}},[s,e.text,e.start,e.end,c]),d=""!==e.text.slice(e.start,e.end).trim();return(0,t.createElement)(g.BlockControls,null,(0,t.createElement)(u,{isGenerating:r,onGenerateImage:m,isTextSelected:d,estimatedDurationMs:i}))};(0,h.registerFormatType)("kaigen/custom-format",{title:"AI Image Gen",tagName:"span",className:"kaigen-format",edit:({value:e})=>(0,t.createElement)(k,{value:e})});const b=window.wp.hooks;(0,b.addFilter)("editor.MediaUpload","kaigen/add-ai-tab",e=>a=>{const r=a.allowedTypes&&a.allowedTypes.includes("image")&&!a.multiple,n=wp.data.select("core/block-editor").getSelectedBlock(),l=n&&"core/image"===n.name,i=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_has_api_key,o=r&&l&&!(n&&n.attributes&&n.attributes.url)&&i;return(0,t.createElement)(e,{...a,render:e=>(0,t.createElement)(t.Fragment,null,a.render(e),(0,t.createElement)(m,{onSelect:a.onSelect,shouldDisplay:o}))})});const f=window.wp.apiFetch;var E=e.n(f);(0,b.addFilter)("editor.BlockEdit","kaigen/add-regenerate-button",e=>n=>{if("core/image"!==n.name)return(0,t.createElement)(e,{...n});const l=Number(n.attributes.id),i=Number.isInteger(l)&&l>0,[o,s]=(0,a.useState)(!1),[c,m]=(0,a.useState)(null),[d,p]=(0,a.useState)(!1),[h,k]=(0,a.useState)([]),[b,f]=(0,a.useState)(!1),[w,_]=(0,a.useState)(!1),[y,v]=(0,a.useState)(null),{attributes:{kaigen_reference_image:N},setAttributes:I}=n;(0,a.useEffect)(()=>{i&&!o&&(null==N?E()({path:`/wp/v2/media/${l}`}).then(e=>{if(e&&e.meta&&void 0!==e.meta.kaigen_reference_image){const t=!0===e.meta.kaigen_reference_image||1===e.meta.kaigen_reference_image;I({kaigen_reference_image:t})}s(!0)}).catch(()=>{s(!0)}):s(!0))},[i,l,N,o,I]),(0,a.useEffect)(()=>{l&&(n.attributes.id!==l&&I({id:l}),m(null),k([]),v(null))},[l,n.attributes.id,I]),(0,a.useEffect)(()=>{b&&l&&y!==l&&(p(!0),E()({path:`/kaigen/v1/generation-meta?attachment_id=${l}`}).then(e=>{m(e&&Object.keys(e).length?e:null)}).catch(()=>{m(null)}).finally(()=>{p(!1),v(l)}))},[b,l,y]),(0,a.useEffect)(()=>{if(!(b&&c&&Array.isArray(c.reference_image_ids)&&c.reference_image_ids.length))return void k([]);const e=c.reference_image_ids.join(",");E()({path:`/wp/v2/media?include=${e}&per_page=${c.reference_image_ids.length}`}).then(e=>{const t=Array.isArray(e)?e.map(e=>({id:e.id,url:e.media_details?.sizes?.thumbnail?.source_url||e.source_url})).filter(e=>e.url):[];k(t)}).catch(()=>{k([])})},[b,c]);const S=n.attributes.url?{url:n.attributes.url,id:n.attributes.id,alt:n.attributes.alt||""}:null;return(0,t.createElement)(t.Fragment,null,(0,t.createElement)(e,{...n}),n.attributes.url&&(0,t.createElement)(g.BlockControls,null,(0,t.createElement)(u,{onImageGenerated:e=>{e.id&&"number"==typeof e.id&&e.id>0?n.setAttributes({url:e.url,id:e.id}):n.setAttributes({url:e.url,id:void 0}),wp.data.dispatch("core/notices").createSuccessNotice("Image generated successfully!",{type:"snackbar"})},isImageBlock:!0,currentImage:S})),i&&(0,t.createElement)(g.InspectorControls,null,(0,t.createElement)(r.PanelBody,{title:"KaiGen",initialOpen:!1,onToggle:e=>{f(e)}},(0,t.createElement)(r.CheckboxControl,{label:"Reference image",checked:!0===n.attributes.kaigen_reference_image,onChange:async e=>{const t=!0===e;n.setAttributes({kaigen_reference_image:t}),s(!0);try{await E()({path:`/wp/v2/media/${l}`,method:"POST",data:{meta:{kaigen_reference_image:t?1:0}}})}catch(e){wp.data.dispatch("core/notices").createErrorNotice("Failed to update reference image meta",{type:"snackbar"})}},help:"Add to the list of reference images."}),(0,t.createElement)(r.Button,{variant:"secondary",isBusy:w,disabled:w,style:{marginTop:"8px"},onClick:async()=>{const e=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider||"";if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please set one in the plugin settings.",{type:"snackbar"});const t=c?.prompt_text?c.prompt_text:"string"==typeof c?.prompt?c.prompt:n.attributes.alt||"";if(!t.trim()&&!l)return void wp.data.dispatch("core/notices").createErrorNotice("No prompt or image available to generate alt text.",{type:"snackbar"});let a=null;if(c&&"string"==typeof c.prompt)try{const e=JSON.parse(c.prompt);e&&"object"==typeof e&&(a=e)}catch(e){a=null}_(!0);try{const r=await(async(e,t,a=null,r=null)=>{try{const n={prompt:e,provider:t};a&&(n.prompt_structured=a),r&&(n.attachment_id=r);const l=await wp.apiFetch({path:"/kaigen/v1/generate-alt-text",method:"POST",data:n});if(l&&l.code&&l.message)throw new Error(l.message);return l}catch(e){throw new Error(e.message||"An unknown error occurred while generating alt text")}})(t.trim(),e,a,l),n=r?.alt_text||"";if(!n)throw new Error("Alt text response was empty.");I({alt:n}),await E()({path:`/wp/v2/media/${l}`,method:"POST",data:{alt_text:n}}),wp.data.dispatch("core/notices").createSuccessNotice("Alt text generated.",{type:"snackbar"})}catch(e){wp.data.dispatch("core/notices").createErrorNotice("Failed to generate alt text.",{type:"snackbar"})}finally{_(!1)}}},"Generate Alt Text"),(0,t.createElement)("p",{className:"components-base-control__help"},"Generate a descriptive alt text suggestion for this image."),d&&(0,t.createElement)("p",{className:"kaigen-generation-meta-loading"},"Loading generation details..."),!d&&c&&(0,t.createElement)("table",{className:"kaigen-generation-meta-table"},(0,t.createElement)("tbody",null,(0,t.createElement)("tr",null,(0,t.createElement)("th",null,"Prompt"),(0,t.createElement)("td",null,c.prompt)),(0,t.createElement)("tr",null,(0,t.createElement)("th",null,"Provider"),(0,t.createElement)("td",null,c.provider)),(0,t.createElement)("tr",null,(0,t.createElement)("th",null,"Quality"),(0,t.createElement)("td",null,c.quality)),(0,t.createElement)("tr",null,(0,t.createElement)("th",null,"Model"),(0,t.createElement)("td",null,c.model)),h.length>0&&(0,t.createElement)("tr",null,(0,t.createElement)("th",null,"References"),(0,t.createElement)("td",null,(0,t.createElement)("div",{className:"kaigen-generation-meta-images"},h.map(e=>(0,t.createElement)("img",{key:e.id,src:e.url,alt:"",className:"kaigen-generation-meta-image"}))))))))))}),(0,b.addFilter)("blocks.registerBlockType","kaigen/add-reference-image-attribute",(e,t)=>"core/image"!==t?e:{...e,attributes:{...e.attributes,kaigen_reference_image:{type:"boolean",default:!1}}})})();