(()=>{"use strict";var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var r in a)e.o(a,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:a[r]})}};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var a=e.g.document;if(!t&&a&&(a.currentScript&&(t=a.currentScript.src),!t)){var r=a.getElementsByTagName("script");if(r.length)for(var n=r.length-1;n>-1&&(!t||!/^http(s?):/.test(t));)t=r[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})();const t=window.React,a=window.wp.element,r=window.wp.components,n=e.p+"images/KaiGen-logo-64x64.bc835c8b.png",o=e.p+"images/KaiGen-logo-128x128.3bfc1fa5.png",i=async(e,t,a={})=>{try{const r=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!r)throw new Error("No provider configured. Please check your plugin settings.");const n=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_has_api_key;if(!n)throw new Error("No API key configured for the selected provider. Please add one in the KaiGen settings.");const o={prompt:e,provider:r};a.sourceImageUrl&&(o.source_image_url=a.sourceImageUrl),a.additionalImageUrls&&Array.isArray(a.additionalImageUrls)&&(o.additional_image_urls=a.additionalImageUrls),a.maskUrl&&(o.mask_url=a.maskUrl),a.moderation&&["auto","low"].includes(a.moderation)&&(o.moderation=a.moderation),a.style&&["natural","vivid"].includes(a.style)&&(o.style=a.style),a.aspectRatio&&["1:1","16:9","9:16","4:3","3:4"].includes(a.aspectRatio)&&(o.aspect_ratio=a.aspectRatio);const i=await wp.apiFetch({path:"/kaigen/v1/generate-image",method:"POST",data:o});if(i.code&&i.message){if("content_moderation"===i.code)throw new Error(i.message);if("replicate_error"===i.code)throw new Error("Image generation failed: "+i.message);throw new Error(i.message)}if(!i||!i.url)throw new Error("Invalid response from server: "+JSON.stringify(i));i.id&&"number"==typeof i.id&&i.id>0?t({url:i.url,alt:e,id:i.id,caption:""}):t({url:i.url,alt:e,caption:""})}catch(e){console.error("Image generation failed:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),t({error:e.message||"An unknown error occurred while generating the image"})}},l=({onSelect:e,shouldDisplay:l})=>{const[c,s]=(0,a.useState)(!1),[d,m]=(0,a.useState)(""),[g,u]=(0,a.useState)(!1),[p,k]=(0,a.useState)(null),[b,w]=(0,a.useState)([]),[E,f]=(0,a.useState)(null),[h,y]=(0,a.useState)("1:1"),v=window.kaiGen?.supportsImageToImage||!1;(0,a.useEffect)((()=>{c&&v&&(async()=>{try{const e=await wp.apiFetch({path:"/kaigen/v1/reference-images",method:"GET"});return Array.isArray(e)?e:[]}catch(e){return console.error("Failed to fetch reference images:",e),[]}})().then(w)}),[c]);const I=()=>{if(!d.trim())return void k("Please enter a prompt for image generation.");u(!0),k(null);const t={};E&&(t.sourceImageUrl=E.url),h&&(t.aspectRatio=h),i(d.trim(),(t=>{t.error?(k(t.error),u(!1)):(e(t),u(!1),s(!1))}),t)};return l?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.Button,{onClick:()=>s(!0),className:"kaigen-placeholder-button","aria-label":"KaiGen",role:"button",title:"KaiGen",style:{order:10}},(0,t.createElement)("img",{src:n,alt:"KaiGen","aria-label":"KaiGen logo",role:"button",title:"KaiGen logo"})),c&&(0,t.createElement)(r.Modal,{className:"kaigen-modal",title:(0,t.createElement)("div",{className:"kaigen-modal__logo-container"},(0,t.createElement)("img",{src:o,alt:"KaiGen logo",className:"kaigen-modal__logo"})),"aria-label":"KaiGen",onRequestClose:()=>s(!1)},p&&(0,t.createElement)("p",{className:"kaigen-error-text"},p),(0,t.createElement)("div",{className:"kaigen-modal__input-container"},v&&b.length>0&&(0,t.createElement)(r.Dropdown,{onFocusOutside:()=>setIsOpen(!1),popoverProps:{placement:"bottom-start",focusOnMount:!0},renderToggle:({isOpen:e,onToggle:a})=>(0,t.createElement)(r.Button,{className:"kaigen-modal__ref-button "+(E?"kaigen-ref-button-selected":""),onClick:a,"aria-expanded":e,"aria-label":"Reference Images"},(0,t.createElement)(r.Dashicon,{icon:"format-image",className:E?"kaigen-ref-button-icon-selected":""})),renderContent:()=>(0,t.createElement)("div",{className:"kaigen-modal-dropdown-content-container"},(0,t.createElement)("h4",{className:"kaigen-modal-dropdown-content-title"},"Reference Images"),(0,t.createElement)("div",{className:"kaigen-modal-reference-images-container"},b.map((e=>(0,t.createElement)("img",{key:e.id,src:e.url,alt:e.alt||"",onClick:()=>E&&E.id===e.id?f(null):f(e),className:"kaigen-modal-reference-image "+(E&&E.id===e.id?"kaigen-modal-reference-image-selected":"")})))))}),(0,t.createElement)("div",{className:"kaigen-modal__textarea-container"},(0,t.createElement)(r.TextareaControl,{className:"kaigen-modal__textarea",placeholder:"Image prompt...",value:d,onChange:m,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),I())},rows:2})),d.trim()&&(0,t.createElement)(r.Button,{className:"kaigen-modal__submit-button",variant:"primary",onClick:I,disabled:g||!d.trim(),"aria-label":"Generate Image"},g?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.Spinner,null)):(0,t.createElement)(r.Dashicon,{icon:"admin-appearance"})),(0,t.createElement)(r.Dropdown,{onFocusOutside:()=>setIsOpen(!1),popoverProps:{placement:"bottom-end",focusOnMount:!0},renderToggle:({isOpen:e,onToggle:a})=>(0,t.createElement)(r.Button,{className:"kaigen-modal__settings-button",onClick:a,"aria-expanded":e,"aria-label":"Settings"},(0,t.createElement)(r.Dashicon,{icon:"admin-generic"})),renderContent:()=>(0,t.createElement)("div",{className:"kaigen-modal-dropdown-content-container"},(0,t.createElement)("h4",{className:"kaigen-modal-dropdown-content-title"},"Aspect Ratio"),(0,t.createElement)("div",{className:"kaigen-modal-aspect-ratio-container"},[{value:"1:1",label:"1:1",title:"Square"},{value:"16:9",label:"16:9",title:"Landscape"},{value:"9:16",label:"9:16",title:"Portrait"}].map((e=>(0,t.createElement)("div",{key:e.value,onClick:()=>y((t=>t===e.value?null:e.value)),"aria-pressed":h===e.value,"aria-label":`${e.title} (${e.label})`,className:"kaigen-modal__aspect-ratio-button "+(h===e.value?"kaigen-modal__aspect-ratio-button-selected":"")},(0,t.createElement)("div",{className:"kaigen-modal-aspect-ratio-icon-container"},(0,t.createElement)("div",{className:`kaigen-modal-aspect-ratio-icon ${h===e.value?"kaigen-modal-aspect-ratio-icon-selected":""} kaigen-aspect-ratio-${e.value.replace(":","-")}`})),(0,t.createElement)("span",{className:"kaigen-modal-aspect-ratio-label"},e.label))))))})))):null},c=({isGenerating:e,onGenerateImage:o,isRegenerating:i,onRegenerateImage:l,isImageBlock:c,isTextSelected:s,supportsImageToImage:d})=>{const[m,g]=(0,a.useState)(!1),[u,p]=(0,a.useState)(""),[k,b]=(0,a.useState)(null);return c&&d?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.ToolbarGroup,null,(0,t.createElement)(r.ToolbarButton,{icon:i?(0,t.createElement)(r.Spinner,null):(0,t.createElement)("img",{src:n,alt:"KaiGen logo",className:"kaigen-toolbar-icon"}),label:i?"KaiGen is generating...":"KaiGen",onClick:()=>g(!0),disabled:i})),m&&(0,t.createElement)(r.Modal,{title:(0,t.createElement)("img",{src:n,alt:"KaiGen logo",className:"kaigen-modal-logo"}),onRequestClose:()=>{g(!1),p(""),b(null)}},k&&(0,t.createElement)("p",{className:"kaigen-error-text"},k),(0,t.createElement)(r.TextareaControl,{label:"Editing Instructions (optional)",value:u,onChange:p,rows:4}),(0,t.createElement)(r.Button,{variant:"primary",onClick:()=>{l(u.trim()),g(!1),p(""),b(null)},disabled:i},i?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(r.Spinner,null),"Regenerating..."):"Regenerate Image"))):s?(0,t.createElement)(r.ToolbarGroup,null,(0,t.createElement)(r.ToolbarButton,{icon:e?(0,t.createElement)(r.Spinner,null):"format-image",label:e?"KaiGen is generating...":"KaiGen",onClick:o,disabled:e})):null},s=window.wp.blockEditor,d=window.wp.data;(0,window.wp.richText.registerFormatType)("kaigen/custom-format",{title:"AI Image Gen",tagName:"span",className:"kaigen-format",edit:({isActive:e,value:r,onChange:n})=>{const[o,l]=(0,a.useState)(!1),m=(0,d.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:g}=(0,d.useDispatch)("core/block-editor"),u=(0,a.useCallback)((()=>{if(m&&"core/paragraph"===m.name){const e=r.text.slice(r.start,r.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!t)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please set one in the plugin settings.",{type:"snackbar"});const a=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,className:"kaigen-text-center"});g(m.clientId,[a,m]),l(!0),i(e,(e=>{if(l(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),g(a.clientId,[]);else{let t={url:e.url,alt:e.alt,caption:""};e.id&&"number"==typeof e.id&&e.id>0&&(t.id=e.id);const r=wp.blocks.createBlock("core/image",t);g(a.clientId,[r])}}))}}),[m,r.text,r.start,r.end,g]),p=""!==r.text.slice(r.start,r.end).trim();return(0,t.createElement)(s.BlockControls,null,(0,t.createElement)(c,{isGenerating:o,onGenerateImage:u,isTextSelected:p}))}});const m=window.wp.hooks;(0,m.addFilter)("editor.MediaUpload","kaigen/add-ai-tab",(e=>a=>{const r=a.allowedTypes&&a.allowedTypes.includes("image")&&!a.multiple,n=wp.data.select("core/block-editor").getSelectedBlock(),o=n&&"core/image"===n.name,i=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_has_api_key,c=r&&o&&!(n&&n.attributes&&n.attributes.url)&&i;return(0,t.createElement)(e,{...a,render:e=>(0,t.createElement)(t.Fragment,null,a.render(e),(0,t.createElement)(l,{onSelect:a.onSelect,shouldDisplay:c}))})}));const g=window.wp.apiFetch;var u=e.n(g);(0,m.addFilter)("editor.BlockEdit","kaigen/add-regenerate-button",(e=>n=>{if("core/image"!==n.name)return(0,t.createElement)(e,{...n});const o=n.attributes.id&&"number"==typeof n.attributes.id&&n.attributes.id>0,[l,d]=(0,a.useState)(!1),[m,g]=(0,a.useState)(null),[p,k]=(0,a.useState)(!1);return(0,a.useEffect)((()=>{(async()=>{try{const e=window.kaiGen?.provider,t=window.kaiGen?.supportsImageToImage||!1;if(!e)return;k(t)}catch(e){console.error("Failed to initialize provider:",e)}})()}),[]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(e,{...n}),(0,t.createElement)(s.BlockControls,null,(0,t.createElement)(c,{isRegenerating:l,onRegenerateImage:async e=>{g(null);const t=e||n.attributes.alt||"no alt text or prompt, please just enhance",a=window.kaiGen?.provider;if(!a)return console.error("No provider configured"),void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please check your plugin settings.",{type:"snackbar"});d(!0);try{const e=n.attributes.url,a={};p&&e?a.sourceImageUrl=e:p&&!e&&(console.warn("Image-to-image requested but no source image URL available"),wp.data.dispatch("core/notices").createWarningNotice("Image-to-image generation requires a source image. Please ensure the image is properly loaded.",{type:"snackbar"}));const r=await new Promise(((e,r)=>{i(t,(t=>{t.error?r(new Error(t.error)):e(t)}),a)}));r.id&&"number"==typeof r.id&&r.id>0?n.setAttributes({url:r.url,id:r.id}):n.setAttributes({url:r.url,id:void 0}),wp.data.dispatch("core/notices").createSuccessNotice("Image regenerated successfully!",{type:"snackbar"})}catch(e){console.error("Image regeneration failed:",e);let t=e.message||"Unknown error",a="";t.includes("organization verification")?a=" Please verify your organization in the OpenAI dashboard.":t.includes("parameter")?t="API configuration error. Please contact the plugin developer.":t.includes("content policy")&&(a=" Try a different prompt."),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+t+a,{type:"snackbar"})}finally{d(!1)}},isImageBlock:!0,supportsImageToImage:p})),o&&(0,t.createElement)(s.InspectorControls,null,(0,t.createElement)(r.PanelBody,{title:"KaiGen Settings",initialOpen:!1},(0,t.createElement)(r.CheckboxControl,{label:"Reference image",checked:n.attributes.kaigen_reference_image||!1,onChange:async e=>{n.setAttributes({kaigen_reference_image:e});try{await u()({path:`/wp/v2/media/${n.attributes.id}`,method:"POST",data:{meta:{kaigen_reference_image:e?1:0}}})}catch(e){console.error("Failed to update reference image meta:",e),wp.data.dispatch("core/notices").createErrorNotice("Failed to update reference image meta",{type:"snackbar"})}},help:"Add to the list of reference images."}))))})),(0,m.addFilter)("blocks.registerBlockType","kaigen/add-reference-image-attribute",((e,t)=>"core/image"!==t?e:{...e,attributes:{...e.attributes,kaigen_reference_image:{type:"boolean",default:!1}}}))})();