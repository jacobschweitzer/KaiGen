(()=>{"use strict";const e=window.React,t=window.wp.hooks,r=window.wp.element,a=window.wp.components,o=window.wp.richText,n=window.wp.blockEditor,i=window.wp.data,l=async()=>{try{return await wp.apiFetch({path:"/wp-ai-image-gen/v1/providers"})}catch(e){return console.error("Error fetching providers:",e),{error:"Unable to fetch providers. Please try again later."}}},c=async(e,t,r)=>{try{const a=await wp.apiFetch({path:"/wp-ai-image-gen/v1/generate-image",method:"POST",data:{prompt:e,provider:t}});if(!a||!a.url)throw a&&a.error&&a.error.includes("NSFW content")?new Error("The image could not be generated due to potential inappropriate content. Please try a different prompt."):new Error("Invalid response from server: "+JSON.stringify(a));r({url:a.url,alt:e,id:a.id||`ai-generated-${Date.now()}`,caption:""})}catch(e){console.error("Detailed error in generateImage:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),r({error:e.message||"Unknown error occurred"})}},s=({onSelect:t,shouldDisplay:o})=>{const[n,i]=(0,r.useState)(!1),[s,d]=(0,r.useState)(""),[m,g]=(0,r.useState)(!1),[p,u]=(0,r.useState)([]),[w,E]=(0,r.useState)(""),[h,I]=(0,r.useState)(null);(0,r.useEffect)((()=>{(async()=>{try{const e=await l();if(e.error)return void I(e.error);u(e);const t=localStorage.getItem("wpAiImageGenLastProvider");t&&e.includes(t)?E(t):e.length>0&&(E(e[0]),localStorage.setItem("wpAiImageGenLastProvider",e[0]))}catch(e){I("Failed to fetch providers: "+e.message)}})()}),[]),(0,r.useEffect)((()=>{w&&localStorage.setItem("wpAiImageGenLastProvider",w)}),[w]);const b=p.map((e=>({value:e,label:e.charAt(0).toUpperCase()+e.slice(1)})));return o?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"block-editor-media-placeholder__url-input-container"},(0,e.createElement)(a.Button,{variant:"secondary",onClick:()=>i(!0),className:"block-editor-media-placeholder__button is-secondary"},"Generate AI Image")),n&&(0,e.createElement)(a.Modal,{title:"WP AI Image Gen",onRequestClose:()=>i(!1)},h&&(0,e.createElement)("p",{style:{color:"red"}},h),b.length>1&&(0,e.createElement)(a.SelectControl,{label:"Select Provider",value:w,options:b,onChange:E}),(0,e.createElement)(a.TextareaControl,{label:"Enter your image prompt",value:s,onChange:d,rows:4}),(0,e.createElement)(a.Button,{variant:"primary",onClick:()=>{s.trim()?w?(g(!0),I(null),c(s.trim(),w,(e=>{e.error?(I(e.error),g(!1)):(t(e),g(!1),i(!1))}))):I("Please select a provider for image generation."):I("Please enter a prompt for image generation.")},disabled:m||!w||!s.trim()},m?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(a.Spinner,null),"Generating..."):"Generate Image"))):null},d=({isGenerating:t,onGenerateImage:r,isRegenerating:o,onRegenerateImage:n,isImageBlock:i,isTextSelected:l})=>i?(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{icon:o?(0,e.createElement)(a.Spinner,null):"update",label:o?"Regenerating AI Image...":"Regenerate AI Image",onClick:n,disabled:o})):l?(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{icon:t?(0,e.createElement)(a.Spinner,null):"format-image",label:t?"Generating AI Image...":"Generate AI Image",onClick:r,disabled:t})):null;(0,o.registerFormatType)("wp-ai-image-gen/custom-format",{title:"AI Image Gen",tagName:"span",className:"wp-ai-image-gen-format",edit:({isActive:t,value:a,onChange:o})=>{const[l,s]=(0,r.useState)(""),[m,g]=(0,r.useState)(!1),p=(0,i.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:u}=(0,i.useDispatch)("core/block-editor");(0,r.useEffect)((()=>{const e=localStorage.getItem("wpAiImageGenLastProvider");e&&s(e)}),[]);const w=(0,r.useCallback)((()=>{if(p&&"core/paragraph"===p.name){const e=a.text.slice(a.start,a.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,style:{textAlign:"center"}});u(p.clientId,[t,p]),g(!0),c(e,l,(e=>{if(g(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),u(t.clientId,[]);else{const r=wp.blocks.createBlock("core/image",{url:e.url,alt:e.alt,caption:"",id:e.id||`ai-generated-${Date.now()}`});u(t.clientId,[r])}}))}}),[p,a.text,a.start,a.end,u,l]),E=""!==a.text.slice(a.start,a.end).trim();return(0,e.createElement)(n.BlockControls,null,(0,e.createElement)(d,{isGenerating:m,onGenerateImage:w,isTextSelected:E}))}}),(0,t.addFilter)("editor.MediaUpload","wp-ai-image-gen/add-ai-tab",(t=>r=>{const a=r.allowedTypes&&r.allowedTypes.includes("image")&&!r.multiple,o=wp.data.select("core/block-editor").getSelectedBlock(),n=o&&"core/image"===o.name,i=a&&n&&!(o&&o.attributes&&o.attributes.url);return(0,e.createElement)(t,{...r,render:t=>(0,e.createElement)(e.Fragment,null,r.render(t),(0,e.createElement)(s,{onSelect:r.onSelect,shouldDisplay:i}))})})),(0,t.addFilter)("editor.BlockEdit","wp-ai-image-gen/add-regenerate-button",(t=>a=>{const[o,i]=(0,r.useState)(!1),[s,m]=(0,r.useState)(""),[g,p]=(0,r.useState)(null);return(0,r.useEffect)((()=>{(async()=>{try{const e=localStorage.getItem("wpAiImageGenLastProvider");if(e){const t=await l();if(!t.error&&t.includes(e))return void m(e)}const t=await l();if(!t.error&&t.length>0){const e=t[0];m(e),localStorage.setItem("wpAiImageGenLastProvider",e)}}catch(e){console.error("Failed to initialize provider:",e),wp.data.dispatch("core/notices").createErrorNotice("Failed to initialize AI provider. Please try again.",{type:"snackbar"})}})()}),[]),"core/image"!==a.name?(0,e.createElement)(t,{...a}):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...a}),(0,e.createElement)(n.BlockControls,null,(0,e.createElement)(d,{isRegenerating:o,onRegenerateImage:async()=>{if(p(null),a.attributes.alt&&""!==a.attributes.alt.trim()){if(!s)try{const e=await l();if(e.error||0===e.length)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider available. Please check your settings.",{type:"snackbar"});m(e[0])}catch(e){return void wp.data.dispatch("core/notices").createErrorNotice("Failed to fetch AI providers. Please try again.",{type:"snackbar"})}i(!0);try{const e=await new Promise(((e,t)=>{c(a.attributes.alt.trim(),s,(r=>{r.error?t(new Error(r.error)):e(r)}))}));a.setAttributes({url:e.url,id:e.id||`ai-generated-${Date.now()}`}),wp.data.dispatch("core/notices").createSuccessNotice("Image regenerated successfully!",{type:"snackbar"})}catch(e){console.error("Image regeneration failed:",e),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+(e.message||"Unknown error"),{type:"snackbar"})}finally{i(!1)}}else wp.data.dispatch("core/notices").createErrorNotice("Please provide alt text to use as the image generation prompt.",{type:"snackbar"})},isImageBlock:!0})))}))})();