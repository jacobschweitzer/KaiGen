(()=>{"use strict";const e=window.React,t=window.wp.element,r=window.wp.components,a=async()=>{try{return await wp.apiFetch({path:"/wp-ai-image-gen/v1/providers"})}catch(e){return console.error("Error fetching providers:",e),{error:"Unable to fetch providers. Please try again later."}}},o=async(e,t,r)=>{try{const a=await wp.apiFetch({path:"/wp-ai-image-gen/v1/generate-image",method:"POST",data:{prompt:e,provider:t}});if(a.code&&a.message){if("content_moderation"===a.code)throw new Error(a.message);if("replicate_error"===a.code)throw new Error("Image generation failed: "+a.message);throw new Error(a.message)}if(!a||!a.url)throw new Error("Invalid response from server: "+JSON.stringify(a));r({url:a.url,alt:e,id:a.id||`ai-generated-${Date.now()}`,caption:""})}catch(e){console.error("Image generation failed:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),r({error:e.message||"An unknown error occurred while generating the image"})}},n=({onSelect:n,shouldDisplay:i})=>{const[l,c]=(0,t.useState)(!1),[s,d]=(0,t.useState)(""),[m,g]=(0,t.useState)(!1),[p,u]=(0,t.useState)([]),[w,h]=(0,t.useState)(""),[E,I]=(0,t.useState)(null);(0,t.useEffect)((()=>{(async()=>{try{const e=await a();if(e.error)return void I(e.error);u(e);const t=localStorage.getItem("wpAiImageGenLastProvider");t&&e.includes(t)?h(t):e.length>0&&(h(e[0]),localStorage.setItem("wpAiImageGenLastProvider",e[0]))}catch(e){I("Failed to fetch providers: "+e.message)}})()}),[]),(0,t.useEffect)((()=>{w&&localStorage.setItem("wpAiImageGenLastProvider",w)}),[w]);const f=p.map((e=>({value:e,label:e.charAt(0).toUpperCase()+e.slice(1)})));return i?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"block-editor-media-placeholder__url-input-container"},(0,e.createElement)(r.Button,{variant:"secondary",onClick:()=>c(!0),className:"components-button is-next-40px-default-size is-secondary"},"Generate AI Image")),l&&(0,e.createElement)(r.Modal,{title:"WP AI Image Gen",onRequestClose:()=>c(!1)},E&&(0,e.createElement)("p",{style:{color:"red"}},E),f.length>1&&(0,e.createElement)(r.SelectControl,{label:"Select Provider",value:w,options:f,onChange:h}),(0,e.createElement)(r.TextareaControl,{label:"Enter your image prompt",value:s,onChange:d,rows:4}),(0,e.createElement)(r.Button,{variant:"primary",onClick:()=>{s.trim()?w?(g(!0),I(null),o(s.trim(),w,(e=>{e.error?(I(e.error),g(!1)):(n(e),g(!1),c(!1))}))):I("Please select a provider for image generation."):I("Please enter a prompt for image generation.")},disabled:m||!w||!s.trim()},m?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(r.Spinner,null)," ","Generating..."):"Generate Image"))):null},i=({isGenerating:t,onGenerateImage:a,isRegenerating:o,onRegenerateImage:n,isImageBlock:i,isTextSelected:l})=>i?(0,e.createElement)(r.ToolbarGroup,null,(0,e.createElement)(r.ToolbarButton,{icon:o?(0,e.createElement)(r.Spinner,null):"update",label:o?"Regenerating AI Image...":"Regenerate AI Image",onClick:n,disabled:o})):l?(0,e.createElement)(r.ToolbarGroup,null,(0,e.createElement)(r.ToolbarButton,{icon:t?(0,e.createElement)(r.Spinner,null):"format-image",label:t?"Generating AI Image...":"Generate AI Image",onClick:a,disabled:t})):null,l=window.wp.blockEditor,c=window.wp.data;(0,window.wp.richText.registerFormatType)("wp-ai-image-gen/custom-format",{title:"AI Image Gen",tagName:"span",className:"wp-ai-image-gen-format",edit:({isActive:r,value:a,onChange:n})=>{const[s,d]=(0,t.useState)(""),[m,g]=(0,t.useState)(!1),p=(0,c.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:u}=(0,c.useDispatch)("core/block-editor");(0,t.useEffect)((()=>{const e=localStorage.getItem("wpAiImageGenLastProvider");e&&d(e)}),[]);const w=(0,t.useCallback)((()=>{if(p&&"core/paragraph"===p.name){const e=a.text.slice(a.start,a.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,style:{textAlign:"center"}});u(p.clientId,[t,p]),g(!0),o(e,s,(e=>{if(g(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),u(t.clientId,[]);else{const r=wp.blocks.createBlock("core/image",{url:e.url,alt:e.alt,caption:"",id:e.id||`ai-generated-${Date.now()}`});u(t.clientId,[r])}}))}}),[p,a.text,a.start,a.end,u,s]),h=""!==a.text.slice(a.start,a.end).trim();return(0,e.createElement)(l.BlockControls,null,(0,e.createElement)(i,{isGenerating:m,onGenerateImage:w,isTextSelected:h}))}});const s=window.wp.hooks;(0,s.addFilter)("editor.MediaUpload","wp-ai-image-gen/add-ai-tab",(t=>r=>{const a=r.allowedTypes&&r.allowedTypes.includes("image")&&!r.multiple,o=wp.data.select("core/block-editor").getSelectedBlock(),i=o&&"core/image"===o.name,l=a&&i&&!(o&&o.attributes&&o.attributes.url);return(0,e.createElement)(t,{...r,render:t=>(0,e.createElement)(e.Fragment,null,r.render(t),(0,e.createElement)(n,{onSelect:r.onSelect,shouldDisplay:l}))})})),(0,s.addFilter)("editor.BlockEdit","wp-ai-image-gen/add-regenerate-button",(r=>n=>{if("core/image"!==n.name)return(0,e.createElement)(r,{...n});const[c,s]=(0,t.useState)(!1),[d,m]=(0,t.useState)(""),[g,p]=(0,t.useState)(null);return(0,t.useEffect)((()=>{(async()=>{try{const e=localStorage.getItem("wpAiImageGenLastProvider");if(e){const t=await a();if(!t.error&&t.includes(e))return void m(e)}const t=await a();if(!t.error&&t.length>0){const e=t[0];m(e),localStorage.setItem("wpAiImageGenLastProvider",e)}}catch(e){console.error("Failed to initialize provider:",e),wp.data.dispatch("core/notices").createErrorNotice("Failed to initialize AI provider. Please try again.",{type:"snackbar"})}})()}),[]),(0,e.createElement)(e.Fragment,null,(0,e.createElement)(r,{...n})," ",(0,e.createElement)(l.BlockControls,null,(0,e.createElement)(i,{isRegenerating:c,onRegenerateImage:async()=>{if(p(null),n.attributes.alt&&""!==n.attributes.alt.trim()){if(!d)try{const e=await a();if(e.error||0===e.length)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider available. Please check your settings.",{type:"snackbar"});m(e[0])}catch(e){return void wp.data.dispatch("core/notices").createErrorNotice("Failed to fetch AI providers. Please try again.",{type:"snackbar"})}s(!0);try{const e=await new Promise(((e,t)=>{o(n.attributes.alt.trim(),d,(r=>{r.error?t(new Error(r.error)):e(r)}))}));n.setAttributes({url:e.url,id:e.id||`ai-generated-${Date.now()}`}),wp.data.dispatch("core/notices").createSuccessNotice("Image regenerated successfully!",{type:"snackbar"})}catch(e){console.error("Image regeneration failed:",e),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+(e.message||"Unknown error"),{type:"snackbar"})}finally{s(!1)}}else wp.data.dispatch("core/notices").createErrorNotice("Please provide alt text to use as the image generation prompt.",{type:"snackbar"})},isImageBlock:!0})))}))})();