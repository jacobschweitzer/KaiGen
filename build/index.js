(()=>{"use strict";const e=window.React,t=window.wp.hooks,r=window.wp.element,a=window.wp.components,n=window.wp.richText,o=window.wp.blockEditor,l=window.wp.data,i=async(e,t,r)=>{try{const a=await wp.apiFetch({path:"/wp-ai-image-gen/v1/generate-image",method:"POST",data:{prompt:e,provider:t}});if(!a||!a.url)throw a&&a.error&&a.error.includes("NSFW content")?new Error("The image could not be generated due to potential inappropriate content. Please try a different prompt."):new Error("Invalid response from server: "+JSON.stringify(a));r({url:a.url,alt:e,id:a.id||`ai-generated-${Date.now()}`,caption:""})}catch(e){console.error("Detailed error in generateImage:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),r({error:e.message||"Unknown error occurred"})}},c=({onSelect:t,shouldDisplay:n})=>{const[o,l]=(0,r.useState)(!1),[c,s]=(0,r.useState)(""),[m,d]=(0,r.useState)(!1),[g,p]=(0,r.useState)({}),[u,w]=(0,r.useState)(""),[E,b]=(0,r.useState)(null),[I,k]=(0,r.useState)("");(0,r.useEffect)((()=>{(async()=>{try{return await wp.apiFetch({path:"/wp-ai-image-gen/v1/providers"})}catch(e){return console.error("Error fetching providers:",e),{error:"Unable to fetch providers. Please try again later."}}})().then((e=>{if(e.error)b(e.error);else{p(e);const t=localStorage.getItem("wpAiImageGenLastProvider");t&&e[t]?(w(t),k(t)):w(Object.keys(e)[0])}}))}),[]),(0,r.useEffect)((()=>{u&&(localStorage.setItem("wpAiImageGenLastProvider",u),k(u))}),[u]);const S=Object.entries(g).map((([e,t])=>({value:t,label:t})));return n?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"block-editor-media-placeholder__url-input-container"},(0,e.createElement)(a.Button,{variant:"secondary",onClick:()=>l(!0),className:"block-editor-media-placeholder__button is-secondary"},"Generate AI Image")),o&&(0,e.createElement)(a.Modal,{title:"WP AI Image Gen",onRequestClose:()=>l(!1)},E&&(0,e.createElement)("p",{style:{color:"red"}},E),S.length>1&&(0,e.createElement)(a.SelectControl,{label:"Select Provider",value:u,options:S,onChange:w}),(0,e.createElement)(a.TextareaControl,{label:"Enter your image prompt",value:c,onChange:s,rows:4}),(0,e.createElement)(a.Button,{variant:"primary",onClick:()=>{c.trim()?(d(!0),b(null),i(c.trim(),u,(e=>{e.error?(b(e.error),d(!1)):(t(e),d(!1),l(!1))}))):b("Please enter a prompt for image generation.")},disabled:m||!u||!c.trim()},m?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(a.Spinner,null),"Generating..."):"Generate Image"))):null},s=({isGenerating:t,onGenerateImage:r,isRegenerating:n,onRegenerateImage:o,isImageBlock:l,isTextSelected:i})=>l?(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{icon:n?(0,e.createElement)(a.Spinner,null):"update",label:n?"Regenerating AI Image...":"Regenerate AI Image",onClick:o,disabled:n})):i?(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{icon:t?(0,e.createElement)(a.Spinner,null):"format-image",label:t?"Generating AI Image...":"Generate AI Image",onClick:r,disabled:t})):null;(0,n.registerFormatType)("wp-ai-image-gen/custom-format",{title:"AI Image Gen",tagName:"span",className:"wp-ai-image-gen-format",edit:({isActive:t,value:a,onChange:n})=>{const[c,m]=(0,r.useState)(""),[d,g]=(0,r.useState)(!1),p=(0,l.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:u}=(0,l.useDispatch)("core/block-editor");(0,r.useEffect)((()=>{const e=localStorage.getItem("wpAiImageGenLastProvider");e&&m(e)}),[]);const w=(0,r.useCallback)((()=>{if(p&&"core/paragraph"===p.name){const e=a.text.slice(a.start,a.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,style:{textAlign:"center"}});u(p.clientId,[t,p]),g(!0),i(e,c,(e=>{if(g(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),u(t.clientId,[]);else{const r=wp.blocks.createBlock("core/image",{url:e.url,alt:e.alt,caption:"",id:e.id||`ai-generated-${Date.now()}`});u(t.clientId,[r])}}))}}),[p,a.text,a.start,a.end,u,c]),E=""!==a.text.slice(a.start,a.end).trim();return(0,e.createElement)(o.BlockControls,null,(0,e.createElement)(s,{isGenerating:d,onGenerateImage:w,isTextSelected:E}))}}),(0,t.addFilter)("editor.MediaUpload","wp-ai-image-gen/add-ai-tab",(t=>r=>{const a=r.allowedTypes&&r.allowedTypes.includes("image")&&!r.multiple,n=wp.data.select("core/block-editor").getSelectedBlock(),o=n&&"core/image"===n.name,l=a&&o&&!(n&&n.attributes&&n.attributes.url);return(0,e.createElement)(t,{...r,render:t=>(0,e.createElement)(e.Fragment,null,r.render(t),(0,e.createElement)(c,{onSelect:r.onSelect,shouldDisplay:l}))})})),(0,t.addFilter)("editor.BlockEdit","wp-ai-image-gen/add-regenerate-button",(t=>a=>{const[n,l]=(0,r.useState)(!1),[c,m]=(0,r.useState)(""),[d,g]=(0,r.useState)(null);return(0,r.useEffect)((()=>{const e=localStorage.getItem("wpAiImageGenLastProvider");e&&m(e)}),[]),"core/image"!==a.name?(0,e.createElement)(t,{...a}):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...a}),(0,e.createElement)(o.BlockControls,null,(0,e.createElement)(s,{isRegenerating:n,onRegenerateImage:()=>{a.attributes.alt&&""!==a.attributes.alt.trim()?(l(!0),i(a.attributes.alt.trim(),c,(e=>{l(!1),e.error?(console.error("Image regeneration failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+e.error,{type:"snackbar"})):a.setAttributes({url:e.url,id:e.id||`ai-generated-${Date.now()}`})}))):wp.data.dispatch("core/notices").createErrorNotice("Please provide alt text to use as the image generation prompt.",{type:"snackbar"})},isImageBlock:!0})))}))})();