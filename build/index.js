(()=>{"use strict";const e=window.React,t=window.wp.hooks,r=window.wp.element,a=window.wp.components,n=window.wp.richText,o=window.wp.blockEditor,l=window.wp.data,i=async()=>{try{return await wp.apiFetch({path:"/wp-ai-image-gen/v1/providers"})}catch(e){return console.error("Error fetching providers:",e),{error:"Unable to fetch providers. Please try again later."}}},c=async(e,t,r)=>{try{const a=await wp.apiFetch({path:"/wp-ai-image-gen/v1/generate-image",method:"POST",data:{prompt:e,provider:t}});if(!a||!a.url)throw a&&a.error&&a.error.includes("NSFW content")?new Error("The image could not be generated due to potential inappropriate content. Please try a different prompt."):new Error("Invalid response from server: "+JSON.stringify(a));r({url:a.url,alt:e,id:a.id||`ai-generated-${Date.now()}`,caption:""})}catch(e){console.error("Detailed error in generateImage:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),r({error:e.message||"Unknown error occurred"})}},s=({onSelect:t,shouldDisplay:n})=>{const[o,l]=(0,r.useState)(!1),[s,m]=(0,r.useState)(""),[d,g]=(0,r.useState)(!1),[p,u]=(0,r.useState)({}),[w,E]=(0,r.useState)(""),[I,b]=(0,r.useState)(null);(0,r.useEffect)((()=>{i().then((e=>{if(e.error)b(e.error);else{u(e);const t=localStorage.getItem("wpAiImageGenLastProvider");t&&e.includes(t)?E(t):E(e[0]||"")}}))}),[]),(0,r.useEffect)((()=>{w&&localStorage.setItem("wpAiImageGenLastProvider",w)}),[w]);const h=p.map((e=>({value:e,label:e})));return n?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"block-editor-media-placeholder__url-input-container"},(0,e.createElement)(a.Button,{variant:"secondary",onClick:()=>l(!0),className:"block-editor-media-placeholder__button is-secondary"},"Generate AI Image")),o&&(0,e.createElement)(a.Modal,{title:"WP AI Image Gen",onRequestClose:()=>l(!1)},I&&(0,e.createElement)("p",{style:{color:"red"}},I),h.length>1&&(0,e.createElement)(a.SelectControl,{label:"Select Provider",value:w,options:h,onChange:E}),(0,e.createElement)(a.TextareaControl,{label:"Enter your image prompt",value:s,onChange:m,rows:4}),(0,e.createElement)(a.Button,{variant:"primary",onClick:()=>{s.trim()?(g(!0),b(null),c(s.trim(),w,(e=>{e.error?(b(e.error),g(!1)):(t(e),g(!1),l(!1))}))):b("Please enter a prompt for image generation.")},disabled:d||!w||!s.trim()},d?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(a.Spinner,null),"Generating..."):"Generate Image"))):null},m=({isGenerating:t,onGenerateImage:r,isRegenerating:n,onRegenerateImage:o,isImageBlock:l,isTextSelected:i})=>l?(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{icon:n?(0,e.createElement)(a.Spinner,null):"update",label:n?"Regenerating AI Image...":"Regenerate AI Image",onClick:o,disabled:n})):i?(0,e.createElement)(a.ToolbarGroup,null,(0,e.createElement)(a.ToolbarButton,{icon:t?(0,e.createElement)(a.Spinner,null):"format-image",label:t?"Generating AI Image...":"Generate AI Image",onClick:r,disabled:t})):null;(0,n.registerFormatType)("wp-ai-image-gen/custom-format",{title:"AI Image Gen",tagName:"span",className:"wp-ai-image-gen-format",edit:({isActive:t,value:a,onChange:n})=>{const[i,s]=(0,r.useState)(""),[d,g]=(0,r.useState)(!1),p=(0,l.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:u}=(0,l.useDispatch)("core/block-editor");(0,r.useEffect)((()=>{const e=localStorage.getItem("wpAiImageGenLastProvider");e&&s(e)}),[]);const w=(0,r.useCallback)((()=>{if(p&&"core/paragraph"===p.name){const e=a.text.slice(a.start,a.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,style:{textAlign:"center"}});u(p.clientId,[t,p]),g(!0),c(e,i,(e=>{if(g(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),u(t.clientId,[]);else{const r=wp.blocks.createBlock("core/image",{url:e.url,alt:e.alt,caption:"",id:e.id||`ai-generated-${Date.now()}`});u(t.clientId,[r])}}))}}),[p,a.text,a.start,a.end,u,i]),E=""!==a.text.slice(a.start,a.end).trim();return(0,e.createElement)(o.BlockControls,null,(0,e.createElement)(m,{isGenerating:d,onGenerateImage:w,isTextSelected:E}))}}),(0,t.addFilter)("editor.MediaUpload","wp-ai-image-gen/add-ai-tab",(t=>r=>{const a=r.allowedTypes&&r.allowedTypes.includes("image")&&!r.multiple,n=wp.data.select("core/block-editor").getSelectedBlock(),o=n&&"core/image"===n.name,l=a&&o&&!(n&&n.attributes&&n.attributes.url);return(0,e.createElement)(t,{...r,render:t=>(0,e.createElement)(e.Fragment,null,r.render(t),(0,e.createElement)(s,{onSelect:r.onSelect,shouldDisplay:l}))})})),(0,t.addFilter)("editor.BlockEdit","wp-ai-image-gen/add-regenerate-button",(t=>a=>{const[n,l]=(0,r.useState)(!1),[s,d]=(0,r.useState)(""),[g,p]=(0,r.useState)(null);return(0,r.useEffect)((()=>{const e=localStorage.getItem("wpAiImageGenLastProvider");e?d(e):i().then((e=>{if(!e.error&&e.length>0){const t=e[0];d(t),localStorage.setItem("wpAiImageGenLastProvider",t)}}))}),[]),"core/image"!==a.name?(0,e.createElement)(t,{...a}):(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...a}),(0,e.createElement)(o.BlockControls,null,(0,e.createElement)(m,{isRegenerating:n,onRegenerateImage:()=>{a.attributes.alt&&""!==a.attributes.alt.trim()?s?(l(!0),c(a.attributes.alt.trim(),s,(e=>{l(!1),e.error?(console.error("Image regeneration failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+e.error,{type:"snackbar"})):a.setAttributes({url:e.url,id:e.id||`ai-generated-${Date.now()}`})}))):wp.data.dispatch("core/notices").createErrorNotice("No AI provider selected. Please generate an image first.",{type:"snackbar"}):wp.data.dispatch("core/notices").createErrorNotice("Please provide alt text to use as the image generation prompt.",{type:"snackbar"})},isImageBlock:!0})))}))})();