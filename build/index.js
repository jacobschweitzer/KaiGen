(()=>{"use strict";var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var r=e.g.document;if(!t&&r&&(r.currentScript&&(t=r.currentScript.src),!t)){var a=r.getElementsByTagName("script");if(a.length)for(var n=a.length-1;n>-1&&(!t||!/^http(s?):/.test(t));)t=a[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})();const t=window.React,r=window.wp.element,a=window.wp.components,n=e.p+"images/KaiGen-logo-no-background.c1f3e519.png",o=async(e,t,r={})=>{try{const a=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!a)throw new Error("No provider configured. Please check your plugin settings.");const n={prompt:e,provider:a};r.sourceImageUrl&&(n.source_image_url=r.sourceImageUrl),r.additionalImageUrls&&Array.isArray(r.additionalImageUrls)&&(n.additional_image_urls=r.additionalImageUrls),r.maskUrl&&(n.mask_url=r.maskUrl),r.moderation&&["auto","low"].includes(r.moderation)&&(n.moderation=r.moderation),r.style&&["natural","vivid"].includes(r.style)&&(n.style=r.style);const o=await wp.apiFetch({path:"/kaigen/v1/generate-image",method:"POST",data:n});if(o.code&&o.message){if("content_moderation"===o.code)throw new Error(o.message);if("replicate_error"===o.code)throw new Error("Image generation failed: "+o.message);throw new Error(o.message)}if(!o||!o.url)throw new Error("Invalid response from server: "+JSON.stringify(o));o.id&&"number"==typeof o.id&&o.id>0?t({url:o.url,alt:e,id:o.id,caption:""}):t({url:o.url,alt:e,caption:""})}catch(e){console.error("Image generation failed:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),t({error:e.message||"An unknown error occurred while generating the image"})}},i=({onSelect:e,shouldDisplay:i})=>{const[l,c]=(0,r.useState)(!1),[s,d]=(0,r.useState)(""),[g,u]=(0,r.useState)(!1),[m,p]=(0,r.useState)(null),[w,h]=(0,r.useState)([]),[b,E]=(0,r.useState)(null),f=window.kaiGen?.supportsImageToImage||!1;return(0,r.useEffect)((()=>{l&&f&&(async()=>{try{const e=await wp.apiFetch({path:"/kaigen/v1/reference-images",method:"GET"});return Array.isArray(e)?e:[]}catch(e){return console.error("Failed to fetch reference images:",e),[]}})().then(h)}),[l]),i?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.Button,{onClick:()=>c(!0),className:"kaigen-placeholder-button",style:{order:99,padding:0,background:"transparent",border:"none",boxShadow:"none",minWidth:"auto",display:"flex",alignItems:"center",justifyContent:"center"},"aria-label":"KaiGen creator",role:"button",title:"KaiGen creator"},(0,t.createElement)("img",{src:n,alt:"KaiGen",style:{height:"40px",width:"40px",objectFit:"contain",border:"none",background:"transparent"},"aria-label":"KaiGen logo",role:"button",title:"KaiGen logo"})),l&&(0,t.createElement)(a.Modal,{title:(0,t.createElement)("img",{src:n,alt:"KaiGen logo",style:{height:"80px",width:"auto",display:"block"}}),"aria-label":"KaiGen",onRequestClose:()=>c(!1)},m&&(0,t.createElement)("p",{style:{color:"red"}},m),(0,t.createElement)(a.TextareaControl,{label:"Prompt",value:s,onChange:d,rows:4}),f&&w.length>0&&(0,t.createElement)(t.Fragment,null,(0,t.createElement)("h3",null,"Reference Images"),(0,t.createElement)("div",{style:{display:"flex",flexWrap:"wrap",gap:"4px",marginBottom:"8px"}},w.map((e=>(0,t.createElement)("img",{key:e.id,src:e.url,alt:e.alt||"",onClick:()=>b&&b.id===e.id?E(null):E(e),style:{width:"80px",height:"80px",objectFit:"cover",cursor:"pointer",border:b&&b.id===e.id?"4px solid #007cba":"4px solid transparent"}}))))),(0,t.createElement)(a.Button,{variant:"primary",onClick:()=>{if(!s.trim())return void p("Please enter a prompt for image generation.");u(!0),p(null);const t={};b&&(t.sourceImageUrl=b.url),o(s.trim(),(t=>{t.error?(p(t.error),u(!1)):(e(t),u(!1),c(!1))}),t)},disabled:g||!s.trim()},g?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.Spinner,null)," ","KaiGen is generating..."):"KaiGen"))):null},l=({isGenerating:e,onGenerateImage:n,isRegenerating:o,onRegenerateImage:i,isImageBlock:l,isTextSelected:c,supportsImageToImage:s})=>{const[d,g]=(0,r.useState)(!1),[u,m]=(0,r.useState)(""),[p,w]=(0,r.useState)(null);return l&&s?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.ToolbarGroup,null,(0,t.createElement)(a.ToolbarButton,{icon:o?(0,t.createElement)(a.Spinner,null):"update",label:o?"KaiGen is generating...":"KaiGen",onClick:()=>g(!0),disabled:o})),d&&(0,t.createElement)(a.Modal,{title:"KaiGen : Edit Image",onRequestClose:()=>{g(!1),m(""),w(null)}},p&&(0,t.createElement)("p",{style:{color:"red"}},p),(0,t.createElement)(a.TextareaControl,{label:"Editing Instructions (optional)",value:u,onChange:m,rows:4}),(0,t.createElement)(a.Button,{variant:"primary",onClick:()=>{i(u.trim()),g(!1),m(""),w(null)},disabled:o},o?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.Spinner,null),"Regenerating..."):"Regenerate Image"))):c?(0,t.createElement)(a.ToolbarGroup,null,(0,t.createElement)(a.ToolbarButton,{icon:e?(0,t.createElement)(a.Spinner,null):"format-image",label:e?"KaiGen is generating...":"KaiGen",onClick:n,disabled:e})):null},c=window.wp.blockEditor,s=window.wp.data;(0,window.wp.richText.registerFormatType)("kaigen/custom-format",{title:"AI Image Gen",tagName:"span",className:"kaigen-format",edit:({isActive:e,value:a,onChange:n})=>{const[i,d]=(0,r.useState)(!1),g=(0,s.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:u}=(0,s.useDispatch)("core/block-editor"),m=(0,r.useCallback)((()=>{if(g&&"core/paragraph"===g.name){const e=a.text.slice(a.start,a.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!t)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please set one in the plugin settings.",{type:"snackbar"});const r=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,style:{textAlign:"center"}});u(g.clientId,[r,g]),d(!0),o(e,(e=>{if(d(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),u(r.clientId,[]);else{let t={url:e.url,alt:e.alt,caption:""};e.id&&"number"==typeof e.id&&e.id>0&&(t.id=e.id);const a=wp.blocks.createBlock("core/image",t);u(r.clientId,[a])}}))}}),[g,a.text,a.start,a.end,u]),p=""!==a.text.slice(a.start,a.end).trim();return(0,t.createElement)(c.BlockControls,null,(0,t.createElement)(l,{isGenerating:i,onGenerateImage:m,isTextSelected:p}))}});const d=window.wp.hooks;(0,d.addFilter)("editor.MediaUpload","kaigen/add-ai-tab",(e=>r=>{const a=r.allowedTypes&&r.allowedTypes.includes("image")&&!r.multiple,n=wp.data.select("core/block-editor").getSelectedBlock(),o=n&&"core/image"===n.name,l=a&&o&&!(n&&n.attributes&&n.attributes.url);return(0,t.createElement)(e,{...r,render:e=>(0,t.createElement)(t.Fragment,null,r.render(e),(0,t.createElement)(i,{onSelect:r.onSelect,shouldDisplay:l}))})})),(0,d.addFilter)("editor.BlockEdit","kaigen/add-regenerate-button",(e=>a=>{if("core/image"!==a.name)return(0,t.createElement)(e,{...a});const[n,i]=(0,r.useState)(!1),[s,d]=(0,r.useState)(null),[g,u]=(0,r.useState)(!1);return(0,r.useEffect)((()=>{(async()=>{try{const e=window.kaiGen?.provider,t=window.kaiGen?.supportsImageToImage||!1;if(!e)return void console.error("No provider configured in localized data");u(t)}catch(e){console.error("Failed to initialize provider:",e)}})()}),[]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(e,{...a}),(0,t.createElement)(c.BlockControls,null,(0,t.createElement)(l,{isRegenerating:n,onRegenerateImage:async e=>{d(null);const t=e||a.attributes.alt||"no alt text or prompt, please just enhance",r=window.kaiGen?.provider;if(!r)return console.error("No provider configured"),void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please check your plugin settings.",{type:"snackbar"});i(!0);try{const e=a.attributes.url,r={};g&&e?r.sourceImageUrl=e:g&&!e&&(console.warn("Image-to-image requested but no source image URL available"),wp.data.dispatch("core/notices").createWarningNotice("Image-to-image generation requires a source image. Please ensure the image is properly loaded.",{type:"snackbar"}));const n=await new Promise(((e,a)=>{o(t,(t=>{t.error?a(new Error(t.error)):e(t)}),r)}));n.id&&"number"==typeof n.id&&n.id>0?a.setAttributes({url:n.url,id:n.id}):a.setAttributes({url:n.url,id:void 0}),wp.data.dispatch("core/notices").createSuccessNotice("Image regenerated successfully!",{type:"snackbar"})}catch(e){console.error("Image regeneration failed:",e);let t=e.message||"Unknown error",r="";t.includes("organization verification")?r=" Please verify your organization in the OpenAI dashboard.":t.includes("parameter")?t="API configuration error. Please contact the plugin developer.":t.includes("content policy")&&(r=" Try a different prompt."),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+t+r,{type:"snackbar"})}finally{i(!1)}},isImageBlock:!0,supportsImageToImage:g})))}))})();