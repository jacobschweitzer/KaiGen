(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var a in r)e.o(r,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:r[a]})}};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var r=e.g.document;if(!t&&r&&(r.currentScript&&(t=r.currentScript.src),!t)){var a=r.getElementsByTagName("script");if(a.length)for(var n=a.length-1;n>-1&&(!t||!/^http(s?):/.test(t));)t=a[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})();const t=window.React,r=window.wp.element,a=window.wp.components,n=e.p+"images/KaiGen-logo-128x128.5ec09725.png",o=async(e,t,r={})=>{try{const a=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!a)throw new Error("No provider configured. Please check your plugin settings.");const n={prompt:e,provider:a};r.sourceImageUrl&&(n.source_image_url=r.sourceImageUrl),r.additionalImageUrls&&Array.isArray(r.additionalImageUrls)&&(n.additional_image_urls=r.additionalImageUrls),r.maskUrl&&(n.mask_url=r.maskUrl),r.moderation&&["auto","low"].includes(r.moderation)&&(n.moderation=r.moderation),r.style&&["natural","vivid"].includes(r.style)&&(n.style=r.style),r.aspectRatio&&["1:1","16:9","9:16","4:3","3:4"].includes(r.aspectRatio)&&(n.aspect_ratio=r.aspectRatio);const o=await wp.apiFetch({path:"/kaigen/v1/generate-image",method:"POST",data:n});if(o.code&&o.message){if("content_moderation"===o.code)throw new Error(o.message);if("replicate_error"===o.code)throw new Error("Image generation failed: "+o.message);throw new Error(o.message)}if(!o||!o.url)throw new Error("Invalid response from server: "+JSON.stringify(o));o.id&&"number"==typeof o.id&&o.id>0?t({url:o.url,alt:e,id:o.id,caption:""}):t({url:o.url,alt:e,caption:""})}catch(e){console.error("Image generation failed:",e),e.message&&console.error("Error message:",e.message),e.stack&&console.error("Error stack:",e.stack),t({error:e.message||"An unknown error occurred while generating the image"})}},i=({onSelect:e,shouldDisplay:i})=>{const[l,c]=(0,r.useState)(!1),[s,d]=(0,r.useState)(""),[u,g]=(0,r.useState)(!1),[p,m]=(0,r.useState)(null),[h,b]=(0,r.useState)([]),[w,f]=(0,r.useState)(null),[y,k]=(0,r.useState)("1:1"),E=window.kaiGen?.supportsImageToImage||!1;return(0,r.useEffect)((()=>{l&&E&&(async()=>{try{const e=await wp.apiFetch({path:"/kaigen/v1/reference-images",method:"GET"});return Array.isArray(e)?e:[]}catch(e){return console.error("Failed to fetch reference images:",e),[]}})().then(b)}),[l]),i?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.Button,{onClick:()=>c(!0),className:"kaigen-placeholder-button",style:{order:99,padding:0,background:"transparent",border:"none",boxShadow:"none",minWidth:"auto",display:"flex",alignItems:"center",justifyContent:"center"},"aria-label":"KaiGen",role:"button",title:"KaiGen"},(0,t.createElement)("img",{src:n,alt:"KaiGen",style:{height:"40px",width:"40px",objectFit:"contain",border:"none",background:"transparent"},"aria-label":"KaiGen logo",role:"button",title:"KaiGen logo"})),l&&(0,t.createElement)(a.Modal,{title:(0,t.createElement)("img",{src:n,alt:"KaiGen logo",style:{height:"80px",width:"auto",display:"block"}}),"aria-label":"KaiGen",onRequestClose:()=>c(!1)},p&&(0,t.createElement)("p",{style:{color:"red"}},p),(0,t.createElement)(a.TextareaControl,{label:"Prompt",value:s,onChange:d,rows:4}),(0,t.createElement)("div",{style:{margin:"8px 0 12px 0"}},(0,t.createElement)("h4",{style:{margin:"0 0 6px 0"}},"Aspect Ratio"),(0,t.createElement)("div",{style:{display:"flex",gap:"10px"}},[{value:"1:1",label:"1:1",title:"Square"},{value:"16:9",label:"16:9",title:"Landscape"},{value:"9:16",label:"9:16",title:"Portrait"}].map((e=>(0,t.createElement)(a.Button,{key:e.value,onClick:()=>k((t=>t===e.value?null:e.value)),onMouseDown:e=>e.preventDefault(),style:{border:y===e.value?"2px solid #007cba":"1px solid #ccd0d4",background:"#fff",padding:0,width:"75px",height:"75px",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"4px",outline:"none",boxShadow:"none"},"aria-pressed":y===e.value,"aria-label":`${e.title} (${e.label})`,title:`${e.title} (${e.label})`},(0,t.createElement)("div",{style:{width:"50px",height:"36px",background:"transparent",display:"flex",alignItems:"center",justifyContent:"center"}},(()=>{const[r,a]=e.value.split(":").map(Number);let n=40,o=40*a/r;return o>26&&(o=26,n=26*r/a),(0,t.createElement)("div",{style:{width:`${Math.round(n)}px`,height:`${Math.round(o)}px`,background:"#e9eef0",border:"1px solid #c3c4c7"}})})()),(0,t.createElement)("span",{style:{fontSize:"12px",color:"#1e1e1e"}},e.label)))))),E&&h.length>0&&(0,t.createElement)(t.Fragment,null,(0,t.createElement)("div",{style:{width:"250px",marginBottom:"8px"}},(0,t.createElement)("h4",{style:{margin:"0 0 4px 0"}},"Reference Images"),(0,t.createElement)("div",{style:{display:"flex",overflowX:"auto",overflowY:"hidden",gap:"4px",WebkitOverflowScrolling:"touch"}},h.map((e=>(0,t.createElement)("img",{key:e.id,src:e.url,alt:e.alt||"",onClick:()=>w&&w.id===e.id?f(null):f(e),style:{width:"80px",height:"80px",objectFit:"contain",cursor:"pointer",flex:"0 0 auto",border:w&&w.id===e.id?"4px solid #007cba":"4px solid transparent"}})))))),(0,t.createElement)(a.Button,{variant:"primary",onClick:()=>{if(!s.trim())return void m("Please enter a prompt for image generation.");g(!0),m(null);const t={};w&&(t.sourceImageUrl=w.url),y&&(t.aspectRatio=y),o(s.trim(),(t=>{t.error?(m(t.error),g(!1)):(e(t),g(!1),c(!1))}),t)},disabled:u||!s.trim()},u?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.Spinner,null)," ","KaiGen is generating..."):"KaiGen"))):null},l=({isGenerating:e,onGenerateImage:o,isRegenerating:i,onRegenerateImage:l,isImageBlock:c,isTextSelected:s,supportsImageToImage:d})=>{const[u,g]=(0,r.useState)(!1),[p,m]=(0,r.useState)(""),[h,b]=(0,r.useState)(null);return c&&d?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.ToolbarGroup,null,(0,t.createElement)(a.ToolbarButton,{icon:i?(0,t.createElement)(a.Spinner,null):(0,t.createElement)("img",{src:n,alt:"KaiGen logo",style:{height:"20px",width:"20px"}}),label:i?"KaiGen is generating...":"KaiGen",onClick:()=>g(!0),disabled:i})),u&&(0,t.createElement)(a.Modal,{title:(0,t.createElement)("img",{src:n,alt:"KaiGen logo",style:{height:"80px",width:"auto",display:"block"}}),onRequestClose:()=>{g(!1),m(""),b(null)}},h&&(0,t.createElement)("p",{style:{color:"red"}},h),(0,t.createElement)(a.TextareaControl,{label:"Editing Instructions (optional)",value:p,onChange:m,rows:4}),(0,t.createElement)(a.Button,{variant:"primary",onClick:()=>{l(p.trim()),g(!1),m(""),b(null)},disabled:i},i?(0,t.createElement)(t.Fragment,null,(0,t.createElement)(a.Spinner,null),"Regenerating..."):"Regenerate Image"))):s?(0,t.createElement)(a.ToolbarGroup,null,(0,t.createElement)(a.ToolbarButton,{icon:e?(0,t.createElement)(a.Spinner,null):"format-image",label:e?"KaiGen is generating...":"KaiGen",onClick:o,disabled:e})):null},c=window.wp.blockEditor,s=window.wp.data;(0,window.wp.richText.registerFormatType)("kaigen/custom-format",{title:"AI Image Gen",tagName:"span",className:"kaigen-format",edit:({isActive:e,value:a,onChange:n})=>{const[i,d]=(0,r.useState)(!1),u=(0,s.useSelect)((e=>e("core/block-editor").getSelectedBlock()),[]),{replaceBlocks:g}=(0,s.useDispatch)("core/block-editor"),p=(0,r.useCallback)((()=>{if(u&&"core/paragraph"===u.name){const e=a.text.slice(a.start,a.end).trim();if(!e)return void wp.data.dispatch("core/notices").createErrorNotice("Please select some text to use as the image generation prompt.",{type:"snackbar"});const t=wp.data.select("core/editor")?.getEditorSettings()?.kaigen_provider;if(!t)return void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please set one in the plugin settings.",{type:"snackbar"});const r=wp.blocks.createBlock("core/heading",{content:"Generating AI image...",level:2,style:{textAlign:"center"}});g(u.clientId,[r,u]),d(!0),o(e,(e=>{if(d(!1),e.error)console.error("Image generation failed:",e.error),wp.data.dispatch("core/notices").createErrorNotice("Failed to generate image: "+e.error,{type:"snackbar"}),g(r.clientId,[]);else{let t={url:e.url,alt:e.alt,caption:""};e.id&&"number"==typeof e.id&&e.id>0&&(t.id=e.id);const a=wp.blocks.createBlock("core/image",t);g(r.clientId,[a])}}))}}),[u,a.text,a.start,a.end,g]),m=""!==a.text.slice(a.start,a.end).trim();return(0,t.createElement)(c.BlockControls,null,(0,t.createElement)(l,{isGenerating:i,onGenerateImage:p,isTextSelected:m}))}});const d=window.wp.hooks;(0,d.addFilter)("editor.MediaUpload","kaigen/add-ai-tab",(e=>r=>{const a=r.allowedTypes&&r.allowedTypes.includes("image")&&!r.multiple,n=wp.data.select("core/block-editor").getSelectedBlock(),o=n&&"core/image"===n.name,l=a&&o&&!(n&&n.attributes&&n.attributes.url);return(0,t.createElement)(e,{...r,render:e=>(0,t.createElement)(t.Fragment,null,r.render(e),(0,t.createElement)(i,{onSelect:r.onSelect,shouldDisplay:l}))})}));const u=window.wp.apiFetch;var g=e.n(u);(0,d.addFilter)("editor.BlockEdit","kaigen/add-regenerate-button",(e=>n=>{if("core/image"!==n.name)return(0,t.createElement)(e,{...n});const i=n.attributes.id&&"number"==typeof n.attributes.id&&n.attributes.id>0,[s,d]=(0,r.useState)(!1),[u,p]=(0,r.useState)(null),[m,h]=(0,r.useState)(!1);return(0,r.useEffect)((()=>{(async()=>{try{const e=window.kaiGen?.provider,t=window.kaiGen?.supportsImageToImage||!1;if(!e)return void console.error("No provider configured in localized data");h(t)}catch(e){console.error("Failed to initialize provider:",e)}})()}),[]),(0,t.createElement)(t.Fragment,null,(0,t.createElement)(e,{...n}),(0,t.createElement)(c.BlockControls,null,(0,t.createElement)(l,{isRegenerating:s,onRegenerateImage:async e=>{p(null);const t=e||n.attributes.alt||"no alt text or prompt, please just enhance",r=window.kaiGen?.provider;if(!r)return console.error("No provider configured"),void wp.data.dispatch("core/notices").createErrorNotice("No AI provider configured. Please check your plugin settings.",{type:"snackbar"});d(!0);try{const e=n.attributes.url,r={};m&&e?r.sourceImageUrl=e:m&&!e&&(console.warn("Image-to-image requested but no source image URL available"),wp.data.dispatch("core/notices").createWarningNotice("Image-to-image generation requires a source image. Please ensure the image is properly loaded.",{type:"snackbar"}));const a=await new Promise(((e,a)=>{o(t,(t=>{t.error?a(new Error(t.error)):e(t)}),r)}));a.id&&"number"==typeof a.id&&a.id>0?n.setAttributes({url:a.url,id:a.id}):n.setAttributes({url:a.url,id:void 0}),wp.data.dispatch("core/notices").createSuccessNotice("Image regenerated successfully!",{type:"snackbar"})}catch(e){console.error("Image regeneration failed:",e);let t=e.message||"Unknown error",r="";t.includes("organization verification")?r=" Please verify your organization in the OpenAI dashboard.":t.includes("parameter")?t="API configuration error. Please contact the plugin developer.":t.includes("content policy")&&(r=" Try a different prompt."),wp.data.dispatch("core/notices").createErrorNotice("Failed to regenerate image: "+t+r,{type:"snackbar"})}finally{d(!1)}},isImageBlock:!0,supportsImageToImage:m})),i&&(0,t.createElement)(c.InspectorControls,null,(0,t.createElement)(a.PanelBody,{title:"KaiGen Settings",initialOpen:!1},(0,t.createElement)(a.CheckboxControl,{label:"Reference image",checked:n.attributes.kaigen_reference_image||!1,onChange:async e=>{n.setAttributes({kaigen_reference_image:e});try{await g()({path:`/wp/v2/media/${n.attributes.id}`,method:"POST",data:{meta:{kaigen_reference_image:e?1:0}}})}catch(e){console.error("Failed to update reference image meta:",e),wp.data.dispatch("core/notices").createErrorNotice("Failed to update reference image meta",{type:"snackbar"})}},help:"Add to the list of reference images."}))))})),(0,d.addFilter)("blocks.registerBlockType","kaigen/add-reference-image-attribute",((e,t)=>"core/image"!==t?e:{...e,attributes:{...e.attributes,kaigen_reference_image:{type:"boolean",default:!1}}}))})();